<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com data:; img-src 'self' data:; connect-src 'self' data: blob: https: http:; object-src 'none'; base-uri 'none'; frame-ancestors 'none'">
    <meta name="referrer" content="no-referrer">
    <title>ä¸ªäººCRMç®¡ç†ç³»ç»Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ä½¿ç”¨å¾®è½¯é›…é»‘å­—ä½“ï¼Œæ— éœ€å¤–éƒ¨å­—ä½“ -->

    <style>
        :root {
            --bg-gradient: #fafbfc;
            --card-bg: #ffffff;
            --glass-blur: none;
            --accent: #2563eb;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --hover-bg: #f9fafb;
        }
        body {
            font-family: "Microsoft YaHei", "å¾®è½¯é›…é»‘", "SimHei", "é»‘ä½“", Arial, sans-serif;
            background: var(--bg-gradient);
            font-weight: 400;
            line-height: 1.6;
        }
        .notion-card, .notion-table, .card {
            background: var(--card-bg);
            backdrop-filter: var(--glass-blur);
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        .page-title { 
            letter-spacing: 0.02em; 
            color: var(--text-primary);
            font-weight: 600;
        }
        .page-subtitle { 
            opacity: 0.8; 
            color: var(--text-secondary);
        }
        .notion-btn-primary { 
            background-color: var(--accent); 
            border-color: var(--accent); 
            color: white;
            font-weight: 500;
        }
        .notion-btn-primary:hover { 
            background-color: #1d4ed8; 
            border-color: #1d4ed8;
        }
        .btn { 
            @apply px-4 py-2 rounded-lg font-medium transition-all duration-200 cursor-pointer;
            font-family: "Microsoft YaHei", "å¾®è½¯é›…é»‘", Arial, sans-serif;
        }
        .btn-primary { 
            @apply text-white;
            background-color: var(--accent);
            border: 1px solid var(--accent);
        }
        .btn-primary:hover { 
            background-color: #1d4ed8;
            border-color: #1d4ed8;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }
        .btn-success { 
            @apply text-white;
            background-color: #059669;
            border: 1px solid #059669;
        }
        .btn-success:hover { 
            background-color: #047857;
            border-color: #047857;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
        }
        .btn-secondary { 
            @apply text-white;
            background-color: #6b7280;
            border: 1px solid #6b7280;
        }
        .btn-secondary:hover { 
            background-color: #4b5563;
            border-color: #4b5563;
            transform: translateY(-1px);
        }
        .card { 
            @apply rounded-xl p-6;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        .card:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transform: translateY(-1px);
            transition: all 0.2s ease;
        }
        .relationship-node { 
            @apply inline-block px-3 py-1 rounded-full text-sm mr-2 mb-2 cursor-pointer transition-all duration-200;
            background-color: #dbeafe;
            color: #1e40af;
            font-family: "Microsoft YaHei", "å¾®è½¯é›…é»‘", Arial, sans-serif;
        }
        .relationship-node:hover { 
            background-color: #bfdbfe;
            transform: translateY(-1px);
        }
        .project-tag { 
            @apply inline-block px-3 py-1 rounded-full text-sm mr-2 mb-2;
            background-color: #dcfce7;
            color: #166534;
            font-family: "Microsoft YaHei", "å¾®è½¯é›…é»‘", Arial, sans-serif;
        }
        .priority-high { 
            background-color: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            @apply px-3 py-1 rounded-lg text-sm font-medium;
        }
        .priority-medium { 
            background-color: #fffbeb;
            border: 1px solid #fed7aa;
            color: #d97706;
            @apply px-3 py-1 rounded-lg text-sm font-medium;
        }
        .priority-low { 
            background-color: #f9fafb;
            border: 1px solid #d1d5db;
            color: #6b7280;
            @apply px-3 py-1 rounded-lg text-sm font-medium;
        }
        
        /* è¾“å…¥æ¡†å’Œè¡¨å•æ ·å¼ */
        input, textarea, select {
            font-family: "Microsoft YaHei", "å¾®è½¯é›…é»‘", Arial, sans-serif;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 12px;
            transition: all 0.2s ease;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        /* è¡¨æ ¼æ ·å¼ */
        table {
            font-family: "Microsoft YaHei", "å¾®è½¯é›…é»‘", Arial, sans-serif;
        }
        th {
            font-weight: 600;
            color: var(--text-primary);
        }
        td {
            color: var(--text-secondary);
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- ç™»å½•/æ³¨å†Œé®ç½©ï¼ˆæ‰‹æœºæˆ–é‚®ç®±ï¼‰ -->
    <div id="authOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-md p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-3 text-center">ç™»å½•åˆ° Personal CRM</h2>
            <div class="flex mb-4 border rounded-lg overflow-hidden">
                <button id="tabEmail" class="flex-1 py-2 bg-blue-50 text-blue-700" onclick="switchLoginTab('email')">é‚®ç®±ç™»å½•</button>
            </div>
            <div id="emailLoginSection" class="space-y-3">
                <input id="emailInput" type="email" class="notion-input" placeholder="é‚®ç®±" autocomplete="email">
                <input id="passwordInput" type="password" class="notion-input" placeholder="å¯†ç " autocomplete="current-password">
                <div class="flex gap-2">
                    <button class="notion-btn notion-btn-primary flex-1" onclick="emailSignIn()">é‚®ç®±ç™»å½•</button>
                    <button class="notion-btn notion-btn-secondary flex-1" onclick="emailSignUp()">æ³¨å†Œ</button>
                </div>
            </div>
            <p id="loginError" class="text-xs text-red-600 mt-2 hidden"></p>
        </div>
    </div>

    <div id="appRoot" style="display:none">
        <div class="flex h-screen">
        <!-- ä¾§è¾¹æ  - å®½æ•èˆ’é€‚ç‰ˆæœ¬ -->
        <div class="w-72 sidebar flex flex-col">
            <!-- é¡¶éƒ¨æ ‡é¢˜åŒºåŸŸ - æ›´å¤šç•™ç™½ -->
            <div class="px-6 py-8" style="text-align:center;">
                <h1 class="text-lg font-bold text-gray-900 mb-1">ä¸ªäººç®¡ç†ç³»ç»Ÿ</h1>
                <p class="text-xs text-gray-500">Personal CRM Platform</p>
            </div>
            
            <!-- å¯¼èˆªåŒºåŸŸ - å®½æ•é—´è· -->
            <nav class="flex-1 px-5 py-6">
                <div class="space-y-5" style="row-gap: 2.5rem; align-items:stretch;">
                    <a href="#" onclick="showView('dashboard')" class="nav-item active" data-view="dashboard">
                        <div class="flex items-center">
                    <div class="w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center mr-4">
                                <span class="text-lg">ğŸ“Š</span>
                            </div>
                            <div>
                                <div class="text-base font-medium text-gray-900">å·¥ä½œå°</div>
                                <div class="text-sm text-gray-500 mt-0.5">Dashboard</div>
                            </div>
                        </div>
                    </a>
                    
                    <a href="#" onclick="showView('contacts')" class="nav-item" data-view="contacts">
                        <div class="flex items-center">
                    <div class="w-10 h-10 bg-green-100 rounded-xl flex items-center justify-center mr-4">
                                <span class="text-lg">ğŸ‘¥</span>
                            </div>
                            <div>
                                <div class="text-base font-medium text-gray-700">è”ç³»äººç½‘ç»œ</div>
                                <div class="text-sm text-gray-500 mt-0.5">Contacts</div>
                            </div>
                        </div>
                    </a>
                    
                    
                    
                    <a href="#" onclick="showView('opportunities')" class="nav-item" data-view="opportunities">
                        <div class="flex items-center">
                    <div class="w-10 h-10 bg-yellow-100 rounded-xl flex items-center justify-center mr-4">
                                <span class="text-lg">ğŸ’¡</span>
                            </div>
                            <div>
                                <div class="text-base font-medium text-gray-700">å•†ä¸šæœºä¼š</div>
                                <div class="text-sm text-gray-500 mt-0.5">Opportunities</div>
                            </div>
                        </div>
                    </a>
                    
                    <a href="#" onclick="showView('schedule')" class="nav-item" data-view="schedule">
                        <div class="flex items-center">
                    <div class="w-10 h-10 bg-red-100 rounded-xl flex items-center justify-center mr-4">
                                <span class="text-lg">ğŸ“…</span>
                            </div>
                            <div>
                                <div class="text-base font-medium text-gray-700">æ—¥ç¨‹å®‰æ’</div>
                                <div class="text-sm text-gray-500 mt-0.5">Schedule</div>
                            </div>
                        </div>
                    </a>
                </div>
            </nav>
            
            <!-- åº•éƒ¨ç”¨æˆ·ä¿¡æ¯ - æ›´ç¾è§‚çš„å¸ƒå±€ -->
            <div class="px-6 py-6 border-t border-gray-100">
                <div class="flex items-center p-4 bg-gray-50 rounded-xl">
                    <div class="w-12 h-12 bg-gradient-to-br from-blue-400 to-blue-600 rounded-full flex items-center justify-center mr-4" style="margin-left:auto;margin-right:auto;">
                        <span class="text-white text-lg font-medium">L</span>
                    </div>
                    <div class="flex-1">
                        <div class="text-base font-semibold text-gray-900 text-center">Laura Zhao</div>
                        <div class="text-sm text-gray-500 text-center">è‚¡æƒæŠ•èµ„äºº</div>
                    </div>
                    <div class="w-6 h-6 text-gray-400"></div>
                </div>
                <button onclick="logout()" class="notion-btn notion-btn-secondary text-xs mt-3 w-full">é€€å‡ºç™»å½•</button>
                <button onclick="showView('settings')" class="notion-btn notion-btn-ghost text-xs mt-2 w-full">âš™ï¸ è®¾ç½®</button>
            </div>
        </div>

        <!-- ä¸»å†…å®¹åŒº -->
        <main class="flex-1 overflow-y-auto main-content">
            <!-- å·¥ä½œå°è§†å›¾ -->
            <div id="dashboard-view" class="view-content" style="padding: var(--vc-pad, 2rem);">
                <div class="mb-8">
                    <h1 class="page-title">å·¥ä½œå°</h1>
                    <p class="page-subtitle">åŸºäºå…³ç³»ç½‘ç»œçš„æ™ºèƒ½å·¥ä½œç®¡ç†</p>
                </div>

                <!-- é¡¶éƒ¨ï¼šä»Šæ—¥å¾…åŠ ä¸ æ˜æ—¥æé†’ï¼ˆæ”¾åœ¨æœ€ä¸Šæ–¹ï¼‰ -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="notion-card">
                        <h3 class="text-base font-medium text-gray-900 mb-2">ğŸ“ ä»Šæ—¥å¾…åŠ</h3>
                        <textarea id="todayTodos" class="w-full p-3 border border-gray-200 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 resize-y" rows="5" placeholder="è¾“å…¥ä»Šå¤©çš„é‡è¦å¾…åŠ..." onblur="saveTodayTodos()"></textarea>
                    </div>
                    <div class="notion-card">
                        <h3 class="text-base font-medium text-gray-900 mb-2">ğŸ“Œ æ˜æ—¥æé†’äº‹é¡¹</h3>
                        <textarea id="tomorrowReminderCRM" class="w-full p-3 border border-yellow-300 rounded-lg bg-yellow-50 focus:outline-none focus:ring-2 focus:ring-yellow-500 resize-y" rows="5" placeholder="è¾“å…¥æ˜å¤©éœ€è¦æ³¨æ„æˆ–å‡†å¤‡çš„é‡è¦äº‹é¡¹..." onblur="saveTomorrowReminderCRM()"></textarea>
                    </div>
                </div>

                <!-- æ ¸å¿ƒæ•°æ®å¡ç‰‡ -->
                <div class="grid grid-cols-1 md:grid-cols-4" style="gap: var(--vc-gap, 1rem); margin-bottom: var(--vc-pad, 2rem);">
                    <div class="notion-stat-card">
                        <div class="flex items-center">
                            <div class="text-2xl mr-3">ğŸ‘¥</div>
                            <div>
                                <div class="text-lg font-semibold text-gray-900" id="totalContacts">156</div>
                                <div class="text-sm text-gray-600">æ ¸å¿ƒè”ç³»äºº</div>
                            </div>
                        </div>
                    </div>
                    <div class="notion-stat-card">
                        <div class="flex items-center">
                            <div class="text-2xl mr-3">ğŸ¢</div>
                            <div>
                                <div class="text-lg font-semibold text-gray-900" id="activeProjects">23</div>
                                <div class="text-sm text-gray-600">è¿›è¡Œä¸­é¡¹ç›®</div>
                            </div>
                        </div>
                    </div>
                    <div class="notion-stat-card">
                        <div class="flex items-center">
                            <div class="text-2xl mr-3">ğŸŒ</div>
                            <div>
                                <div class="text-lg font-semibold text-gray-900" id="relationships">89</div>
                                <div class="text-sm text-gray-600">å…³è”å…³ç³»</div>
                            </div>
                        </div>
                    </div>
                    <div class="notion-stat-card">
                        <div class="flex items-center">
                            <div class="text-2xl mr-3">âš¡</div>
                            <div>
                                <div class="text-lg font-semibold text-gray-900" id="opportunities">12</div>
                                <div class="text-sm text-gray-600">æ¨èæœºä¼š</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ä»Šæ—¥é‡ç‚¹å…³ç³» -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="notion-card">
                        <h3 class="text-base font-medium text-gray-900 mb-4">ğŸ¯ ä»Šæ—¥é‡ç‚¹è”ç³»</h3>
                        <div class="space-y-4" id="todayContacts">
                            <!-- åŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>

                    <div class="notion-card">
                        <h3 class="text-base font-medium text-gray-900 mb-4">ğŸ’¡ åŸºäºå…³ç³»çš„æ¨è</h3>
                        <div class="space-y-4" id="relationshipRecommendations">
                            <!-- åŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- è”ç³»äººç½‘ç»œè§†å›¾ -->
            <div id="contacts-view" class="view-content hidden p-8">
                <div class="mb-6">
                    <div class="flex justify-between items-start">
                        <div>
                            <h1 class="page-title">è”ç³»äººç½‘ç»œ</h1>
                            <p class="page-subtitle">ç®¡ç†æŠ•èµ„å…³ç³»ç½‘ç»œ</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button onclick="toggleContactView('table')" id="tableViewBtn" class="notion-btn notion-btn-primary text-sm">è¡¨æ ¼è§†å›¾</button>
                            <button onclick="toggleContactView('graph')" id="graphViewBtn" class="notion-btn notion-btn-secondary text-sm">å…³ç³»å›¾è°±</button>
                            <button onclick="addContact()" class="notion-btn notion-btn-primary">æ–°å»º</button>
                        </div>
                    </div>
                    <div class="mb-6">
                        <input type="text" placeholder="æœç´¢è”ç³»äººæˆ–å…¬å¸..." class="notion-input max-w-sm" id="contactSearch" oninput="searchContacts()">
                    </div>
                </div>

                <!-- è¡¨æ ¼è§†å›¾ -->
            <div id="contactTableView" class="notion-table">
                <table class="w-full text-sm">
                        <thead>
                            <tr>
                                <th class="min-w-24">å§“å</th>
                                <th class="min-w-32">èŒä½</th>
                                <th class="min-w-32">æ‰€åœ¨æœºæ„</th>
                                <th class="min-w-40">æŠ•èµ„åå¥½</th>
                                <th class="w-24">å…³ç³»è¿œè¿‘</th>
                                <th class="min-w-24">æ¨èäºº</th>
                                <th class="min-w-32">è”ç³»æ–¹å¼</th>
                                <th class="w-20">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="contactsTable">
                            <!-- åŠ¨æ€ç”Ÿæˆ -->
                        </tbody>
                    </table>
                </div>

                <!-- å…³ç³»å›¾è°±è§†å›¾ -->
                <div id="contactGraphView" class="hidden">
                    <div class="notion-card">
                        <div class="h-96 flex items-center justify-center bg-gray-50 rounded-lg">
                            <div class="text-center">
                                <span class="text-6xl mb-4 block">ğŸŒ</span>
                                <p class="text-gray-600 text-lg mb-2">å…³ç³»ç½‘ç»œå›¾è°±</p>
                                <p class="text-sm text-gray-500">å¯è§†åŒ–å±•ç¤ºè”ç³»äººä¹‹é—´çš„å…³è”å…³ç³»</p>
                                <div class="mt-4 space-y-2">
                                    <div class="flex items-center justify-center space-x-4">
                                        <div class="flex items-center">
                                            <div class="w-4 h-4 bg-blue-500 rounded-full mr-2"></div>
                                            <span class="text-sm text-gray-600">æŠ•èµ„äºº</span>
                                        </div>
                                        <div class="flex items-center">
                                            <div class="w-4 h-4 bg-green-500 rounded-full mr-2"></div>
                                            <span class="text-sm text-gray-600">åˆ›ä¸šè€…</span>
                                        </div>
                                        <div class="flex items-center">
                                            <div class="w-4 h-4 bg-purple-500 rounded-full mr-2"></div>
                                            <span class="text-sm text-gray-600">åˆä½œä¼™ä¼´</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>



            <!-- é¡¹ç›®ç®¡ç†è§†å›¾ -->
            <div id="projects-view" class="view-content hidden p-8">
                <div class="mb-8">
                    <div class="flex justify-between items-start">
                        <div>
                            <h1 class="page-title">é¡¹ç›®ç®¡ç†</h1>
                            <p class="page-subtitle">æŠ•èµ„é¡¹ç›®è·Ÿè¸ªç®¡ç†</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <input type="file" id="excelFileInput" accept=".xlsx,.xls,.csv" class="hidden" onchange="importExcelFile()">
                            <button onclick="document.getElementById('excelFileInput').click()" class="notion-btn notion-btn-secondary">å¯¼å…¥Excel</button>
                            <button onclick="addProject()" class="notion-btn notion-btn-primary">æ–°å»º</button>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
                    <div class="notion-card">
                        <h3 class="font-semibold text-gray-700 mb-3">ğŸ“‹ å¾…æ¥è§¦</h3>
                        <div class="space-y-3" id="pipeline-initial">
                            <!-- åŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                    <div class="notion-card">
                        <h3 class="font-semibold text-gray-700 mb-3">ğŸ” å°½èŒè°ƒæŸ¥</h3>
                        <div class="space-y-3" id="pipeline-dd">
                            <!-- åŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                    <div class="notion-card">
                        <h3 class="font-semibold text-gray-700 mb-3">ğŸ“Š æŠ•å§”ä¼š</h3>
                        <div class="space-y-3" id="pipeline-ic">
                            <!-- åŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                    <div class="notion-card">
                        <h3 class="font-semibold text-gray-700 mb-3">âœ… å·²æŠ•èµ„</h3>
                        <div class="space-y-3" id="pipeline-invested">
                            <!-- åŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- å•†ä¸šæœºä¼šè§†å›¾ -->
            <div id="opportunities-view" class="view-content hidden" style="padding: var(--vc-pad, 2rem);">
                <div class="mb-8">
                    <h1 class="page-title">å•†ä¸šæœºä¼š</h1>
                    <p class="page-subtitle">é¡¹ç›®è·Ÿè¸ªä¸åˆä½œä¼™ä¼´æ¨è</p>
                </div>

                <!-- å•†ä¸šæœºä¼šè¡¨æ ¼ -->
                <div class="notion-table">
                    <table class="w-full">
                        <thead>
                            <tr>
                                <th class="min-w-32">é¡¹ç›®åç§°</th>
                                <th class="min-w-24">é¡¹ç›®ç±»å‹</th>
                                <th class="min-w-40">é¡¹ç›®ä¿¡æ¯</th>
                                <th class="min-w-24">å¯é¢„æœŸæ”¶è´¹</th>
                                <th class="min-w-32">åˆä½œå¯¹è±¡</th>
                                <th class="min-w-32">å¯æ¨èåˆä½œä¼™ä¼´</th>
                                <th class="min-w-32">å·²æ¨èåˆä½œä¼™ä¼´</th>
                                <th class="min-w-28">åˆä½œæ„å‘è·Ÿè¿›</th>
                                <th class="w-24">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="opportunitiesTable">
                            <!-- åŠ¨æ€ç”Ÿæˆ -->
                        </tbody>
                    </table>
                </div>
            </div>



            <!-- æ—¥ç¨‹å®‰æ’è§†å›¾ -->
            <div id="schedule-view" class="view-content hidden" style="padding: var(--vc-pad, 2rem);">
                <div class="mb-8">
                    <div class="flex justify-between items-start">
                        <div>
                            <h1 class="page-title">æ—¥ç¨‹å®‰æ’</h1>
                            <p class="page-subtitle">æ™ºèƒ½æ—¥ç¨‹ç®¡ç†</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button onclick="toggleScheduleView('day')" id="dayViewBtn" class="notion-btn notion-btn-primary text-sm">æ—¥è§†å›¾</button>
                            <button onclick="toggleScheduleView('week')" id="weekViewBtn" class="notion-btn notion-btn-secondary text-sm">å‘¨è§†å›¾</button>
                            <input 
                                type="date" 
                                id="scheduleDateSelector" 
                                class="notion-input text-sm w-auto"
                                onchange="changeScheduleDate(this.value)"
                            >
                            <button onclick="goToScheduleToday()" class="notion-btn notion-btn-ghost text-sm">ä»Šå¤©</button>
                        </div>
                    </div>
                </div>

                <!-- æ—¥è§†å›¾ -->
                <div id="dayScheduleView" class="notion-card">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-base font-medium text-gray-900" id="scheduleTimelineTitle">ä»Šæ—¥æ—¥ç¨‹æ—¶é—´çº¿</h3>
                        <button onclick="saveScheduleChanges()" class="notion-btn notion-btn-primary">ä¿å­˜</button>
                    </div>
                    <div class="notion-table">
                        <table class="w-full">
                            <thead>
                                <tr>
                                    <th class="w-20">æ—¶é—´</th>
                                    <th class="min-w-48">äº‹é¡¹</th>
                                    <th class="w-28">ç´§æ€¥ç¨‹åº¦</th>
                                    <th class="min-w-48">å¤‡æ³¨ä¿¡æ¯</th>
                                </tr>
                            </thead>
                            <tbody id="scheduleTimelineTable">
                                <!-- æ—¶é—´çº¿è¡¨æ ¼å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- å‘¨è§†å›¾ -->
                <div id="weekScheduleView" class="card hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-900" id="weekViewTitle">æœ¬å‘¨æ—¥ç¨‹æ¦‚è§ˆ</h3>
                        <div class="flex items-center space-x-2">
                            <button onclick="previousWeek()" class="btn-secondary text-sm">â† ä¸Šå‘¨</button>
                            <button onclick="nextWeek()" class="btn-secondary text-sm">ä¸‹å‘¨ â†’</button>
                            <button onclick="saveScheduleChanges()" class="btn-success text-sm">ğŸ’¾ ä¿å­˜æ›´æ”¹</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse">
                            <thead>
                                <tr class="bg-gray-50 border-b-2 border-gray-200">
                                    <th class="text-left py-3 px-3 font-medium text-gray-700 w-16">æ—¶é—´</th>
                                    <th class="text-left py-3 px-3 font-medium text-gray-700 min-w-32">å‘¨ä¸€</th>
                                    <th class="text-left py-3 px-3 font-medium text-gray-700 min-w-32">å‘¨äºŒ</th>
                                    <th class="text-left py-3 px-3 font-medium text-gray-700 min-w-32">å‘¨ä¸‰</th>
                                    <th class="text-left py-3 px-3 font-medium text-gray-700 min-w-32">å‘¨å››</th>
                                    <th class="text-left py-3 px-3 font-medium text-gray-700 min-w-32">å‘¨äº”</th>
                                    <th class="text-left py-3 px-3 font-medium text-gray-700 min-w-32">å‘¨å…­</th>
                                    <th class="text-left py-3 px-3 font-medium text-gray-700 min-w-32">å‘¨æ—¥</th>
                                </tr>
                            </thead>
                            <tbody id="weekScheduleTable">
                                <!-- å‘¨è§†å›¾è¡¨æ ¼å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                            </tbody>
                        </table>
                    </div>
                </div>

                
            </div>

            <!-- è®¾ç½®è§†å›¾ -->
            <div id="settings-view" class="view-content hidden p-8">
                <div class="mb-6">
                    <h1 class="page-title">è®¾ç½®</h1>
                    <p class="page-subtitle">è‡ªå®šä¹‰ç•Œé¢æ¯”ä¾‹ä¸æ˜¾ç¤ºåå¥½</p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="notion-card">
                        <h3 class="text-base font-medium text-gray-900 mb-3">ç•Œé¢å¯†åº¦</h3>
                        <select id="settingDensity" class="notion-input w-full">
                            <option value="compact">ç´§å‡‘</option>
                            <option value="comfortable">æ ‡å‡†</option>
                            <option value="spacious">å®½æ¾</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-2">æ§åˆ¶å…¨å±€é—´è·ã€å¡ç‰‡å†…è¾¹è·ã€è¡¨æ ¼è¡Œé«˜ã€‚</p>
                    </div>

                    <div class="notion-card">
                        <h3 class="text-base font-medium text-gray-900 mb-3">å­—ä½“å¤§å°</h3>
                        <select id="settingFontScale" class="notion-input w-full">
                            <option value="small">å°</option>
                            <option value="default">é»˜è®¤</option>
                            <option value="large">å¤§</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-2">è°ƒæ•´å…¨å±€åŸºç¡€å­—å·ï¼Œå½±å“å„æ¨¡å—æ–‡æœ¬ã€‚</p>
                    </div>

                    <div class="notion-card">
                        <h3 class="text-base font-medium text-gray-900 mb-3">ä¸»é¢˜é£æ ¼</h3>
                        <select id="settingTheme" class="notion-input w-full">
                            <option value="light">æµ…è‰²ï¼ˆæ¸…çˆ½ï¼‰</option>
                            <option value="serif">ä¹¦é¦™ï¼ˆè¡¬çº¿ï¼‰</option>
                            <option value="ocean">æµ·æ´‹ï¼ˆè“ç»¿æ¸å˜ï¼‰</option>
                            <option value="night">å¤œè‰²ï¼ˆæ·±è‰²ï¼‰</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-2">æ”¹å˜èƒŒæ™¯ã€å¡ç‰‡ç»ç’ƒæ•ˆæœä¸é»˜è®¤å­—ä½“ç»„åˆã€‚</p>
                    </div>

                    <div class="notion-card">
                        <h3 class="text-base font-medium text-gray-900 mb-3">ä¾§è¾¹æ å®½åº¦</h3>
                        <select id="settingSidebarWidth" class="notion-input w-full">
                            <option value="narrow">çª„</option>
                            <option value="default">é»˜è®¤</option>
                            <option value="wide">å®½</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-2">æ ¹æ®å±å¹•å¤§å°ä¸ä¸ªäººå–œå¥½é€‰æ‹©åˆé€‚å®½åº¦ã€‚</p>
                    </div>

                    <div class="notion-card">
                        <h3 class="text-base font-medium text-gray-900 mb-3">æ“ä½œ</h3>
                        <div class="flex items-center space-x-2">
                            <button class="notion-btn notion-btn-primary" onclick="saveAllSettings()">ä¿å­˜è®¾ç½®</button>
                            <button class="notion-btn notion-btn-secondary" onclick="resetAllSettings()">æ¢å¤é»˜è®¤</button>
                        </div>
                        <p id="settingsSavedToast" class="text-xs text-green-600 mt-2 hidden">å·²ä¿å­˜</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // åç«¯APIé…ç½® - è‡ªåŠ¨é€‰æ‹©æœ¬åœ°æˆ–çº¿ä¸Šï¼Œå¯é€šè¿‡ window.PERSONALCRM_API_BASE è¦†ç›–
        const API_BASE_URL = (function() {
            if (window.PERSONALCRM_API_BASE) return window.PERSONALCRM_API_BASE;
            try {
                const params = new URLSearchParams(location.search);
                const override = params.get('api') || params.get('apiBase');
                if (override) {
                    return override.replace(/\/$/, '');
                }
            } catch (_) {}
            if (location.protocol === 'file:') {
                // file:// ç¯å¢ƒä¸‹ä¼˜å…ˆ 127.0.0.1ï¼Œé¿å…æŸäº›ç¯å¢ƒè§£æ localhost å¼‚å¸¸
                return 'http://127.0.0.1:3000/api/auth';
            }
            const isLocal = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
            if (isLocal) return 'http://127.0.0.1:3000/api/auth';
            // çº¿ä¸Šä½¿ç”¨åŒæº
            return `${location.origin}/api/auth`;
        })();
        try { console.info('[PersonalCRM] API_BASE_URL =', API_BASE_URL); } catch (_) {}
        // æ•°æ®APIåŸºå€ï¼ˆåŒæº /apiï¼Œå¯ç”¨ ?dataApi= è¦†ç›–ï¼‰
        const DATA_API_BASE = (function() {
            try {
                const params = new URLSearchParams(location.search);
                const override = params.get('dataApi') || params.get('dataAPI');
                if (override) return override.replace(/\/$/, '');
            } catch(_) {}
            if (location.protocol === 'file:') return 'http://127.0.0.1:3000/api';
            return `${location.origin}/api`;
        })();
        try { console.info('[PersonalCRM] DATA_API_BASE =', DATA_API_BASE); } catch (_) {}
        
        function onAuth() {
            const overlay = document.getElementById('authOverlay');
            const appRoot = document.getElementById('appRoot');
            
            // æ”¯æŒé€šè¿‡ ?forceLogin=1 å¼ºåˆ¶æ˜¾ç¤ºç™»å½•ï¼ˆä¾¿äºè°ƒè¯•æˆ–æ¸…ç¼“å­˜ï¼‰
            try {
                const params = new URLSearchParams(location.search);
                if (params.get('forceLogin') === '1') {
                    sessionStorage.removeItem('userToken');
                    sessionStorage.removeItem('userInfo');
                    sessionStorage.removeItem('loginPhone');
                }
            } catch (_) {}

            // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•ï¼ˆæœ‰æœ‰æ•ˆtokenï¼‰
            const token = sessionStorage.getItem('userToken');
            if (token && isTokenValid(token)) {
                overlay.classList.add('hidden'); 
                appRoot.style.display = 'block';
            } else {
                overlay.classList.remove('hidden'); 
                appRoot.style.display = 'none';
            }
        }
        
        function isTokenValid(token) {
            try {
                // ç®€å•çš„JWT tokenæ£€æŸ¥ï¼ˆå®é™…é¡¹ç›®ä¸­åº”è¯¥éªŒè¯ç­¾åå’Œè¿‡æœŸæ—¶é—´ï¼‰
                const payload = JSON.parse(atob(token.split('.')[1]));
                return payload.exp > Date.now() / 1000;
            } catch (e) {
                return false;
            }
        }

        // ç¦»çº¿åº”æ€¥ï¼šæœ¬åœ°ç”ŸæˆJWTï¼ˆä»…ç”¨äºæ— ç½‘ç»œæˆ–åç«¯ä¸å¯ç”¨æ—¶çš„æ¼”ç¤ºç™»å½•ï¼‰
        function createLocalDemoToken(payload) {
            const header = { alg: 'none', typ: 'JWT' };
            const toB64 = (obj) => btoa(JSON.stringify(obj));
            return `${toB64(header)}.${toB64(payload)}.`; // æ— ç­¾åï¼Œä»…ç”¨äºå‰ç«¯æ¼”ç¤º
        }

        function generateLocalOTP() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }

        function saveOfflineOtp(phone, otp) {
            const data = { otp, expires: Date.now() + 5 * 60 * 1000 };
            sessionStorage.setItem(`offlineOtp_${phone}`, JSON.stringify(data));
        }

        function readOfflineOtp(phone) {
            const raw = sessionStorage.getItem(`offlineOtp_${phone}`);
            if (!raw) return null;
            try { return JSON.parse(raw); } catch { return null; }
        }
        function switchLoginTab(tab) {
            // ä»…ä¿ç•™é‚®ç®±ç™»å½•
            const email = document.getElementById('emailLoginSection');
            const tabEmail = document.getElementById('tabEmail');
            if (email) email.classList.remove('hidden');
            if (tabEmail) tabEmail.className = 'flex-1 py-2 bg-blue-50 text-blue-700';
            document.getElementById('loginError').classList.add('hidden');
        }
        // å·²å–æ¶ˆæ‰‹æœºå·ç™»å½•ç›¸å…³é€»è¾‘
        // é‚®ç®±ç™»å½•å‡½æ•°
        async function emailSignIn() {
            const email = document.getElementById('emailInput').value.trim();
            const password = document.getElementById('passwordInput').value;
            const err = document.getElementById('loginError');
            err.classList.add('hidden');
            
            if (!email || !password) {
                err.textContent = 'è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç ';
                err.classList.remove('hidden');
                return;
            }
            
            // ç®€å•çš„é‚®ç®±æ ¼å¼éªŒè¯
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                err.textContent = 'è¯·è¾“å…¥æ­£ç¡®çš„é‚®ç®±æ ¼å¼';
                err.classList.remove('hidden');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/email-login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email: email, password: password })
                });
                let result = {};
                try { result = await response.json(); } catch (_) {}
                
                if (response.ok && result && result.success) {
                    // ç™»å½•æˆåŠŸ
                    sessionStorage.setItem('userToken', result.token);
                    sessionStorage.setItem('userInfo', JSON.stringify(result.user));
                    
                    // éšè—ç™»å½•ç•Œé¢ï¼Œæ˜¾ç¤ºåº”ç”¨
                    const overlay = document.getElementById('authOverlay');
                    const appRoot = document.getElementById('appRoot');
                    overlay.classList.add('hidden');
                    appRoot.style.display = 'block';
                } else if (result && result.code === 'USER_NOT_FOUND') {
                    // ç”¨æˆ·ä¸å­˜åœ¨ï¼Œè¯¢é—®æ˜¯å¦æ³¨å†Œ
                    if (confirm('è¯¥é‚®ç®±å°šæœªæ³¨å†Œï¼Œæ˜¯å¦ç«‹å³æ³¨å†Œï¼Ÿ')) {
                        await emailSignUp();
                    }
                } else {
                    // åœ¨çº¿å¤±è´¥ï¼Œå°è¯•ç¦»çº¿ç™»å½•
                    try {
                        const offline = await loginOfflineEmail(email, password);
                        if (offline) {
                            sessionStorage.setItem('userToken', offline.token);
                            sessionStorage.setItem('userInfo', JSON.stringify(offline.user));
                            const overlay = document.getElementById('authOverlay');
                            const appRoot = document.getElementById('appRoot');
                            overlay.classList.add('hidden');
                            appRoot.style.display = 'block';
                            return;
                        }
                    } catch (_) {}
                    err.textContent = (result && (result.message || result.error)) || `ç™»å½•å¤±è´¥ (HTTP ${response.status})`;
                    err.classList.remove('hidden');
                }
            } catch (error) {
                console.error('é‚®ç®±ç™»å½•å¤±è´¥:', error);
                // ç¦»çº¿å…œåº•ï¼šå°è¯•ç¦»çº¿é‚®ç®±ç™»å½•
                try {
                    const offline = await loginOfflineEmail(email, password);
                    if (offline) {
                        sessionStorage.setItem('userToken', offline.token);
                        sessionStorage.setItem('userInfo', JSON.stringify(offline.user));
                        const overlay = document.getElementById('authOverlay');
                        const appRoot = document.getElementById('appRoot');
                        overlay.classList.add('hidden');
                        appRoot.style.display = 'block';
                        return;
                    }
                } catch (_) {}
                err.textContent = `ç½‘ç»œé”™è¯¯ï¼š${(error && error.message) ? error.message : 'è¯·ç¨åé‡è¯•'}`;
                err.classList.remove('hidden');
            }
        }
        
        // é‚®ç®±æ³¨å†Œå‡½æ•°
        async function emailSignUp() {
            const email = document.getElementById('emailInput').value.trim();
            const password = document.getElementById('passwordInput').value;
            const err = document.getElementById('loginError');
            err.classList.add('hidden');
            
            if (!email || !password) {
                err.textContent = 'è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç ';
                err.classList.remove('hidden');
                return;
            }
            
            if (password.length < 6) {
                err.textContent = 'å¯†ç è‡³å°‘éœ€è¦6ä½';
                err.classList.remove('hidden');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/email-register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email: email, password: password })
                });
                let result = {};
                try { result = await response.json(); } catch (_) {}
                
                if (response.ok && result && result.success) {
                    sessionStorage.setItem('userToken', result.token);
                    sessionStorage.setItem('userInfo', JSON.stringify(result.user));
                    
                    // éšè—ç™»å½•ç•Œé¢ï¼Œæ˜¾ç¤ºåº”ç”¨
                    const overlay = document.getElementById('authOverlay');
                    const appRoot = document.getElementById('appRoot');
                    overlay.classList.add('hidden');
                    appRoot.style.display = 'block';
                    
                    alert('æ³¨å†Œå¹¶ç™»å½•æˆåŠŸï¼');
                } else {
                    // åœ¨çº¿å¤±è´¥ï¼Œå°è¯•ç¦»çº¿æ³¨å†Œ
                    try {
                        const offline = await registerOfflineEmail(email, password);
                        if (offline) {
                            sessionStorage.setItem('userToken', offline.token);
                            sessionStorage.setItem('userInfo', JSON.stringify(offline.user));
                            const overlay = document.getElementById('authOverlay');
                            const appRoot = document.getElementById('appRoot');
                            overlay.classList.add('hidden');
                            appRoot.style.display = 'block';
                            alert('æ³¨å†Œå¹¶ç™»å½•æˆåŠŸï¼ï¼ˆç¦»çº¿æ¨¡å¼ï¼‰');
                            return;
                        }
                    } catch (_) {}
                    err.textContent = (result && (result.message || result.error)) || `æ³¨å†Œå¤±è´¥ (HTTP ${response.status})`;
                    err.classList.remove('hidden');
                }
            } catch (error) {
                console.error('é‚®ç®±æ³¨å†Œå¤±è´¥:', error);
                // ç¦»çº¿å…œåº•ï¼šå®Œæˆç¦»çº¿é‚®ç®±æ³¨å†Œï¼ˆæœ¬åœ°æ¼”ç¤ºï¼‰
                try {
                    const offline = await registerOfflineEmail(email, password);
                    if (offline) {
                        sessionStorage.setItem('userToken', offline.token);
                        sessionStorage.setItem('userInfo', JSON.stringify(offline.user));
                        const overlay = document.getElementById('authOverlay');
                        const appRoot = document.getElementById('appRoot');
                        overlay.classList.add('hidden');
                        appRoot.style.display = 'block';
                        alert('æ³¨å†Œå¹¶ç™»å½•æˆåŠŸï¼ï¼ˆç¦»çº¿æ¨¡å¼ï¼‰');
                        return;
                    }
                } catch (_) {}
                err.textContent = `ç½‘ç»œé”™è¯¯ï¼š${(error && error.message) ? error.message : 'è¯·ç¨åé‡è¯•'}`;
                err.classList.remove('hidden');
            }
        }

        function abToB64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            for (let i = 0; i < bytes.length; i++) binary += String.fromCharCode(bytes[i]);
            return btoa(binary);
        }
        function b64ToAb(b64) {
            const binary = atob(b64);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
            return bytes.buffer;
        }
        function b64ToU8(b64) { return new Uint8Array(b64ToAb(b64)); }
        function concatU8(a, b) { const r = new Uint8Array(a.length + b.length); r.set(a, 0); r.set(b, a.length); return r; }

        async function hashWithSalt(pass, saltB64) {
            const enc = new TextEncoder();
            const data = concatU8(b64ToU8(saltB64), enc.encode(pass));
            const digest = await crypto.subtle.digest('SHA-256', data);
            return abToB64(digest);
        }
        async function deriveEncryptionKey(pass, saltB64) {
            const enc = new TextEncoder();
            const baseKey = await crypto.subtle.importKey('raw', enc.encode(pass), 'PBKDF2', false, ['deriveKey']);
            const key = await crypto.subtle.deriveKey(
                { name: 'PBKDF2', salt: b64ToU8(saltB64), iterations: 100000, hash: 'SHA-256' },
                baseKey,
                { name: 'AES-GCM', length: 256 },
                false,
                ['encrypt', 'decrypt']
            );
            return key;
        }
        async function encryptString(plain) {
            if (!window._encryptionKey) return null;
            const enc = new TextEncoder();
            const iv = crypto.getRandomValues(new Uint8Array(12));
            const cipherBuf = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, window._encryptionKey, enc.encode(plain));
            return JSON.stringify({ v: 1, iv: abToB64(iv), cipher: abToB64(cipherBuf) });
        }
        async function decryptString(payload) {
            if (!window._encryptionKey) return null;
            try {
                const obj = typeof payload === 'string' ? JSON.parse(payload) : payload;
                if (!obj || !obj.iv || !obj.cipher) return null;
                const iv = b64ToU8(obj.iv);
                const cipherBuf = b64ToAb(obj.cipher);
                const plainBuf = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, window._encryptionKey, cipherBuf);
                return new TextDecoder().decode(plainBuf);
            } catch (e) { return null; }
        }

        // ç¦»çº¿é‚®ç®±ç”¨æˆ·å­˜å‚¨ï¼ˆä½œä¸ºç½‘ç»œä¸å¯ç”¨æ—¶çš„å…œåº•æ–¹æ¡ˆï¼Œä»…ç”¨äºæœ¬åœ°æ¼”ç¤ºï¼‰
        function getOfflineEmailUsers() {
            try { return JSON.parse(localStorage.getItem('offlineEmailUsers') || '{}'); } catch { return {}; }
        }
        function setOfflineEmailUsers(data) {
            localStorage.setItem('offlineEmailUsers', JSON.stringify(data));
        }
        function isCryptoAvailable() { return !!(window.crypto && crypto.subtle && crypto.getRandomValues); }
        function generateSaltB64() {
            const salt = new Uint8Array(16);
            crypto.getRandomValues(salt);
            return abToB64(salt.buffer);
        }
        async function registerOfflineEmail(email, password) {
            const users = getOfflineEmailUsers();
            if (users[email]) throw new Error('è¯¥é‚®ç®±å·²å­˜åœ¨ï¼ˆç¦»çº¿ï¼‰');
            let record = { createdAt: new Date().toISOString() };
            if (isCryptoAvailable()) {
                const salt = generateSaltB64();
                const hash = await hashWithSalt(password, salt);
                record.salt = salt;
                record.hash = hash;
                record.mode = 'pbkdf2-sha256';
            } else {
                record.hash = 'plain:' + password;
                record.mode = 'plain';
            }
            users[email] = record;
            setOfflineEmailUsers(users);

            const payload = { sub: `offline-email:${email}`, email, exp: Math.floor(Date.now() / 1000) + 7 * 24 * 60 * 60 };
            const token = createLocalDemoToken(payload);
            const user = { id: payload.sub, email, phone: null, loginType: 'email', createdAt: record.createdAt };
            return { token, user };
        }
        async function loginOfflineEmail(email, password) {
            const users = getOfflineEmailUsers();
            const record = users[email];
            if (!record) return null;
            if (record.mode === 'pbkdf2-sha256' && record.salt && record.hash) {
                try {
                    const calc = await hashWithSalt(password, record.salt);
                    if (calc !== record.hash) return null;
                } catch (_) { return null; }
            } else if (record.mode === 'plain' && record.hash) {
                if (record.hash !== 'plain:' + password) return null;
            } else { return null; }
            const payload = { sub: `offline-email:${email}`, email, exp: Math.floor(Date.now() / 1000) + 7 * 24 * 60 * 60 };
            const token = createLocalDemoToken(payload);
            const user = { id: payload.sub, email, phone: null, loginType: 'email', createdAt: record.createdAt || new Date().toISOString() };
            return { token, user };
        }
        function logout() {
            // æ¸…é™¤ç”¨æˆ·æ•°æ®
            sessionStorage.removeItem('userToken');
            sessionStorage.removeItem('userInfo');
            sessionStorage.removeItem('loginPhone');
            window._encryptionKey = null;
            
            const overlay = document.getElementById('authOverlay');
            const appRoot = document.getElementById('appRoot');
            if (overlay) overlay.classList.remove('hidden');
            if (appRoot) appRoot.style.display = 'none';
        }
        function setupAuthGate() { onAuth(); switchLoginTab('email'); }
        // ç¤ºä¾‹æ•°æ®
        const contacts = [
            {
                id: 1, name: 'å¼ æ€»', company: 'çº¢æ‰èµ„æœ¬ä¸­å›½', position: 'ç®¡ç†åˆä¼™äºº',
                phone: '138-0013-8888', email: 'zhang@sequoiacap.com',
                industry: ['ç§‘æŠ€', 'AI', 'æ–°èƒ½æº'], relationshipStrength: 95,
                projects: ['AIé¡¹ç›®A', 'æ–°èƒ½æºé¡¹ç›®B'], connections: [2, 3, 7],
                lastContact: '2024-01-20', priority: 'high',
                investmentPreference: ['AI', 'æ–°èƒ½æº', 'Aè½®', 'Bè½®'],
                relationship: 'close',
                referrer: 'ææ€»',
                contactInfo: '138-0013-8888, zhang@sequoiacap.com'
            },
            {
                id: 2, name: 'ææ€»', company: 'è…¾è®¯æŠ•èµ„', position: 'æŠ•èµ„æ€»ç›‘',
                phone: '139-0013-9999', email: 'li@tencent.com',
                industry: ['äº’è”ç½‘', 'æ¸¸æˆ', 'ç¤¾äº¤'], relationshipStrength: 88,
                projects: ['åŒºå—é“¾é¡¹ç›®C'], connections: [1, 4, 5],
                lastContact: '2024-01-18', priority: 'high',
                investmentPreference: ['äº’è”ç½‘', 'æ¸¸æˆ', 'Bè½®', 'Cè½®'],
                relationship: 'close',
                referrer: 'ç‹æ€»',
                contactInfo: '139-0013-9999, li@tencent.com'
            },
            {
                id: 3, name: 'ç‹æ€»', company: 'ç»çº¬åˆ›æŠ•', position: 'åˆä¼™äºº',
                phone: '137-0013-7777', email: 'wang@matrix.com',
                industry: ['ä¼ä¸šæœåŠ¡', 'æ•™è‚²', 'åŒ»ç–—'], relationshipStrength: 82,
                projects: ['ä¼ä¸šæœåŠ¡é¡¹ç›®D'], connections: [1, 6, 8],
                lastContact: '2024-01-15', priority: 'medium',
                investmentPreference: ['ä¼ä¸šæœåŠ¡', 'æ•™è‚²', 'Aè½®', 'Bè½®'],
                relationship: 'medium',
                referrer: 'å¼ æ€»',
                contactInfo: '137-0013-7777, wang@matrix.com'
            },
            {
                id: 4, name: 'åˆ˜æ€»', company: 'å›è”èµ„æœ¬', position: 'è‘£äº‹æ€»ç»ç†',
                phone: '136-0013-6666', email: 'liu@legend.com',
                industry: ['åŒ»ç–—å¥åº·', 'æ¶ˆè´¹'], relationshipStrength: 75,
                projects: ['åŒ»ç–—é¡¹ç›®E'], connections: [2, 5],
                lastContact: '2024-01-12', priority: 'medium',
                investmentPreference: ['åŒ»ç–—å¥åº·', 'æ¶ˆè´¹', 'å¤©ä½¿è½®', 'Aè½®'],
                relationship: 'medium',
                referrer: 'ææ€»',
                contactInfo: '136-0013-6666, liu@legend.com'
            },
            {
                id: 5, name: 'é™ˆæ€»', company: 'åå…´èµ„æœ¬', position: 'æ‰§è¡Œè‘£äº‹',
                phone: '135-0013-5555', email: 'chen@huaxing.com',
                industry: ['TMT', 'æ–°æ¶ˆè´¹'], relationshipStrength: 70,
                projects: [], connections: [2, 4],
                lastContact: '2024-01-10', priority: 'low',
                investmentPreference: ['TMT', 'æ–°æ¶ˆè´¹', 'Bè½®', 'Cè½®'],
                relationship: 'distant',
                referrer: 'åˆ˜æ€»',
                contactInfo: '135-0013-5555, chen@huaxing.com'
            }
        ];

        const projects = [
            {
                id: 1, name: 'AIé¡¹ç›®A', stage: 'dd', priority: 'high',
                contacts: [1], industry: 'äººå·¥æ™ºèƒ½', round: 'Aè½®',
                amount: '5000ä¸‡', description: 'è®¡ç®—æœºè§†è§‰AIå¹³å°'
            },
            {
                id: 2, name: 'æ–°èƒ½æºé¡¹ç›®B', stage: 'ic', priority: 'high',
                contacts: [1], industry: 'æ–°èƒ½æº', round: 'Bè½®',
                amount: '1.2äº¿', description: 'æ™ºèƒ½å……ç”µæ¡©ç½‘ç»œ'
            },
            {
                id: 3, name: 'åŒºå—é“¾é¡¹ç›®C', stage: 'initial', priority: 'medium',
                contacts: [2], industry: 'åŒºå—é“¾', round: 'å¤©ä½¿è½®',
                amount: '800ä¸‡', description: 'DeFié‡‘èæœåŠ¡å¹³å°'
            }
        ];

        // å¯¼èˆªåŠŸèƒ½
        function showView(viewName) {
            // éšè—æ‰€æœ‰è§†å›¾
            document.querySelectorAll('.view-content').forEach(view => {
                view.classList.add('hidden');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„è§†å›¾
            document.getElementById(viewName + '-view').classList.remove('hidden');
            
            // æ›´æ–°å¯¼èˆªçŠ¶æ€
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-view="${viewName}"]`).classList.add('active');

            // åŠ è½½å¯¹åº”æ•°æ®
            if (viewName === 'contacts') {
                toggleContactView('table'); // é»˜è®¤æ˜¾ç¤ºè¡¨æ ¼è§†å›¾
            }
            if (viewName === 'projects') loadProjects();
            if (viewName === 'dashboard') loadDashboard();
            if (viewName === 'opportunities') loadOpportunities();
            if (viewName === 'schedule') {
                initializeScheduleSelector();
                toggleScheduleView('day'); // é»˜è®¤æ˜¾ç¤ºæ—¥è§†å›¾
            }
            if (viewName === 'settings') {
                loadSettingsUI();
            }
        }

        // ============ è®¾ç½®ï¼šçŠ¶æ€å­˜å–ä¸åº”ç”¨ ============
        const SETTINGS_KEY = 'ui-settings-v1';
        function readSettings() {
            try { return JSON.parse(localStorage.getItem(SETTINGS_KEY) || '{}'); } catch { return {}; }
        }
        function writeSettings(s) { localStorage.setItem(SETTINGS_KEY, JSON.stringify(s)); }
        function applySettings(settings) {
            const density = settings.density || 'spacious';
            const fontScale = settings.fontScale || 'large';
            const theme = settings.theme || 'ocean';
            const sidebarWidth = settings.sidebarWidth || 'default';

            // å¯†åº¦å½±å“ï¼šä¸»è§†å›¾å†…è¾¹è·ä¸å¡ç‰‡/è¡¨æ ¼è¡Œé«˜
            const root = document.documentElement;
            if (density === 'compact') {
                root.style.setProperty('--vc-pad', '1.25rem');
                root.style.setProperty('--vc-gap', '0.5rem');
                root.style.setProperty('--row-pad-y', '0.25rem');
            } else if (density === 'comfortable') {
                root.style.setProperty('--vc-pad', '1.5rem');
                root.style.setProperty('--vc-gap', '0.75rem');
                root.style.setProperty('--row-pad-y', '0.5rem');
            } else { // spacious
                root.style.setProperty('--vc-pad', '2rem');
                root.style.setProperty('--vc-gap', '1rem');
                root.style.setProperty('--row-pad-y', '0.75rem');
            }

            // å­—ä½“å€ç‡
            if (fontScale === 'small') document.body.style.fontSize = '14px';
            else if (fontScale === 'large') document.body.style.fontSize = '16.5px';
            else document.body.style.fontSize = '15px';

            // ä¸»é¢˜
            if (theme === 'light') {
                root.style.setProperty('--bg-gradient', 'linear-gradient(135deg, #fafafa 0%, #f5f7fa 100%)');
                root.style.setProperty('--card-bg', 'rgba(255,255,255,0.9)');
            } else if (theme === 'serif') {
                root.style.setProperty('--bg-gradient', 'linear-gradient(135deg, #f8f5f0 0%, #efe9e1 100%)');
                root.style.setProperty('--card-bg', 'rgba(255,253,250,0.85)');
                document.body.style.fontFamily = '\'Noto Serif SC\', \'Inter\', serif';
            } else if (theme === 'night') {
                root.style.setProperty('--bg-gradient', 'linear-gradient(135deg, #0f172a 0%, #111827 100%)');
                root.style.setProperty('--card-bg', 'rgba(17,24,39,0.6)');
                document.body.style.color = '#e5e7eb';
            } else { // ocean
                root.style.setProperty('--bg-gradient', 'linear-gradient(135deg, #e6f0ff 0%, #e8fbf4 100%)');
                root.style.setProperty('--card-bg', 'rgba(255,255,255,0.75)');
                document.body.style.fontFamily = '\'Inter\', \'Noto Serif SC\', sans-serif';
                document.body.style.color = '';
            }

            // ä¾§æ å®½åº¦
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                if (sidebarWidth === 'narrow') sidebar.classList.replace('w-72', 'w-64') || sidebar.classList.replace('w-80', 'w-64');
                else if (sidebarWidth === 'wide') sidebar.classList.replace('w-72', 'w-80') || sidebar.classList.replace('w-64', 'w-80');
                else { // default
                    // å›åˆ°é»˜è®¤ w-72
                    sidebar.classList.remove('w-64', 'w-80');
                    sidebar.classList.add('w-72');
                }
            }
        }
        function loadSettingsUI() {
            const s = readSettings();
            document.getElementById('settingDensity').value = s.density || 'spacious';
            document.getElementById('settingFontScale').value = s.fontScale || 'large';
            document.getElementById('settingSidebarWidth').value = s.sidebarWidth || 'default';
            document.getElementById('settingTheme').value = s.theme || 'ocean';
        }
        function saveAllSettings() {
            const s = readSettings();
            s.density = document.getElementById('settingDensity').value;
            s.fontScale = document.getElementById('settingFontScale').value;
            s.theme = document.getElementById('settingTheme').value;
            s.sidebarWidth = document.getElementById('settingSidebarWidth').value;
            writeSettings(s);
            applySettings(s);
            const t = document.getElementById('settingsSavedToast');
            if (t) { t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'), 1200); }
        }
        function resetAllSettings() {
            localStorage.removeItem(SETTINGS_KEY);
            applySettings({ density:'spacious', fontScale:'large', theme:'ocean', sidebarWidth:'default' });
            loadSettingsUI();
        }

        // åŠ è½½å·¥ä½œå°ï¼ˆä»çº¿ä¸ŠAPIèšåˆç»Ÿè®¡ï¼‰
        async function loadDashboard() {
            try {
                const [contactsRes, oppRes] = await Promise.all([
                    fetch(`${DATA_API_BASE}/contacts?limit=1`).then(r=>r.json()).catch(()=>({})),
                    fetch(`${DATA_API_BASE}/opportunities?limit=1`).then(r=>r.json()).catch(()=>({}))
                ]);
                const contactsCount = Array.isArray(contactsRes.contacts) ? contactsRes.contacts.length : (contactsRes.total || 0);
                const oppCount = Array.isArray(oppRes.opportunities) ? oppRes.opportunities.length : 0;
                const relCount = Math.max(contactsCount - 10, 0);
                const setText = (id, v) => { const el = document.getElementById(id); if (el) el.textContent = String(v); };
                setText('totalContacts', contactsCount || 0);
                setText('relationships', relCount || 0);
                setText('opportunities', oppCount || 0);
            } catch(_) {}
            loadTodayContacts();
            loadRelationshipRecommendations();
        }

        // åŠ è½½ä»Šæ—¥é‡ç‚¹è”ç³»äºº
        function loadTodayContacts() {
            const container = document.getElementById('todayContacts');
            const todayContacts = contacts.filter(c => c.priority === 'high').slice(0, 3);
            
            container.innerHTML = todayContacts.map(contact => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white font-semibold mr-3">
                            ${contact.name[0]}
                        </div>
                        <div>
                            <p class="font-medium text-gray-900">${contact.name}</p>
                            <p class="text-sm text-gray-600">${contact.company}</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">
                            å…³ç³»å¼ºåº¦: ${contact.relationshipStrength}%
                        </span>
                        <button class="btn btn-primary text-xs" onclick="contactPerson(${contact.id})">è”ç³»</button>
                    </div>
                </div>
            `).join('');
        }

        // åŠ è½½å…³ç³»æ¨è
        function loadRelationshipRecommendations() {
            const container = document.getElementById('relationshipRecommendations');
            
            container.innerHTML = `
                <div class="p-3 bg-blue-50 rounded-lg border-l-4 border-blue-500">
                    <p class="font-medium text-blue-900">ğŸ’¡ å¼ æ€» â†’ æ–°é¡¹ç›®æ¨è</p>
                    <p class="text-sm text-blue-700 mt-1">åŸºäºå…±åŒæŠ•èµ„å†å²ï¼Œå¼ æ€»å¯èƒ½å¯¹AIåŒ»ç–—é¡¹ç›®æ„Ÿå…´è¶£</p>
                    <button class="btn btn-primary text-xs mt-2">æŸ¥çœ‹è¯¦æƒ…</button>
                </div>
                <div class="p-3 bg-green-50 rounded-lg border-l-4 border-green-500">
                    <p class="font-medium text-green-900">ğŸ¤ ææ€» â†” ç‹æ€» è¿æ¥</p>
                    <p class="text-sm text-green-700 mt-1">å¯ä»¥ä»‹ç»ææ€»å’Œç‹æ€»è®¤è¯†ï¼Œäº’è¡¥æŠ•èµ„é¢†åŸŸ</p>
                    <button class="btn btn-success text-xs mt-2">å®‰æ’ä»‹ç»</button>
                </div>
                <div class="p-3 bg-purple-50 rounded-lg border-l-4 border-purple-500">
                    <p class="font-medium text-purple-900">âš¡ å…³ç³»å‡æ¸©å»ºè®®</p>
                    <p class="text-sm text-purple-700 mt-1">é™ˆæ€»å·²ç»10å¤©æœªè”ç³»ï¼Œå»ºè®®ä¸»åŠ¨æ²Ÿé€š</p>
                    <button class="btn btn-secondary text-xs mt-2">å‘èµ·è”ç³»</button>
                </div>
            `;
        }

        // åŠ è½½è”ç³»äººåˆ—è¡¨
        function loadContacts() {
            const container = document.getElementById('contactsList');
            
            container.innerHTML = contacts.map(contact => `
                <div class="contact-item p-4 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer" onclick="showContactDetails(${contact.id})">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center text-white font-semibold mr-4">
                                ${contact.name[0]}
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-900">${contact.name}</h3>
                                <p class="text-sm text-gray-600">${contact.position} Â· ${contact.company}</p>
                                <div class="flex items-center mt-2">
                                    ${contact.industry.map(ind => `<span class="relationship-node">${ind}</span>`).join('')}
                                </div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="flex items-center mb-2">
                                <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">
                                    ${contact.relationshipStrength}%
                                </span>
                            </div>
                            <p class="text-xs text-gray-500">æœ€åè”ç³»: ${contact.lastContact}</p>
                            <p class="text-xs text-gray-500">å…³è”: ${contact.connections.length}äºº</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // æ˜¾ç¤ºè”ç³»äººè¯¦æƒ…
        function showContactDetails(contactId) {
            const contact = contacts.find(c => c.id === contactId);
            const connections = contacts.filter(c => contact.connections.includes(c.id));
            
            const panel = document.getElementById('relationshipPanel');
            panel.innerHTML = `
                <h3 class="text-lg font-semibold text-gray-900 mb-4">${contact.name} - å…³ç³»ç½‘ç»œ</h3>
                
                <div class="mb-6">
                    <h4 class="font-medium text-gray-700 mb-2">ğŸ¯ åŸºæœ¬ä¿¡æ¯</h4>
                    <div class="space-y-1 text-sm">
                        <p><span class="text-gray-500">å…¬å¸:</span> ${contact.company}</p>
                        <p><span class="text-gray-500">èŒä½:</span> ${contact.position}</p>
                        <p><span class="text-gray-500">å…³ç³»å¼ºåº¦:</span> ${contact.relationshipStrength}%</p>
                    </div>
                </div>

                <div class="mb-6">
                    <h4 class="font-medium text-gray-700 mb-2">ğŸŒ ç›´æ¥å…³ç³» (${connections.length}äºº)</h4>
                    <div class="space-y-2">
                        ${connections.map(conn => `
                            <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                                <span class="text-sm">${conn.name} - ${conn.company}</span>
                                <span class="text-xs text-blue-600 cursor-pointer" onclick="showContactDetails(${conn.id})">æŸ¥çœ‹</span>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div class="mb-6">
                    <h4 class="font-medium text-gray-700 mb-2">ğŸ¢ ç›¸å…³é¡¹ç›®</h4>
                    <div class="space-y-2">
                        ${contact.projects.map(project => `
                            <span class="project-tag">${project}</span>
                        `).join('')}
                    </div>
                </div>

                <div class="space-y-2">
                    <button class="btn btn-primary w-full text-sm" onclick="contactPerson(${contact.id})">å‘èµ·è”ç³»</button>
                    <button class="btn btn-secondary w-full text-sm" onclick="scheduleWithContact(${contact.id})">å®‰æ’ä¼šè®®</button>
                </div>
            `;
        }

        // åŠ è½½é¡¹ç›®
        function loadProjects() {
            const stages = {
                'initial': document.getElementById('pipeline-initial'),
                'dd': document.getElementById('pipeline-dd'),
                'ic': document.getElementById('pipeline-ic'),
                'invested': document.getElementById('pipeline-invested')
            };

            // æ¸…ç©ºæ‰€æœ‰é˜¶æ®µ
            Object.values(stages).forEach(stage => stage.innerHTML = '');

            projects.forEach(project => {
                const container = stages[project.stage];
                if (container) {
                    container.innerHTML += `
                        <div class="project-card p-3 border border-gray-200 rounded-lg hover:shadow-sm cursor-pointer priority-${project.priority}">
                            <h4 class="font-medium text-gray-900 mb-2">${project.name}</h4>
                            <p class="text-xs text-gray-600 mb-2">${project.description}</p>
                            <div class="flex justify-between items-center text-xs">
                                <span class="bg-gray-100 px-2 py-1 rounded">${project.round}</span>
                                <span class="font-medium text-gray-700">${project.amount}</span>
                            </div>
                            <div class="mt-2">
                                ${project.contacts.map(contactId => {
                                    const contact = contacts.find(c => c.id === contactId);
                                    return `<span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded mr-1">${contact?.name}</span>`;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }
            });
        }

        // æœç´¢è”ç³»äºº
        function searchContacts() {
            const searchTerm = document.getElementById('contactSearch').value.toLowerCase();
            const filteredContacts = contacts.filter(contact => 
                contact.name.toLowerCase().includes(searchTerm) ||
                contact.company.toLowerCase().includes(searchTerm) ||
                contact.industry.some(ind => ind.toLowerCase().includes(searchTerm))
            );
            
            const container = document.getElementById('contactsList');
            container.innerHTML = filteredContacts.map(contact => `
                <div class="contact-item p-4 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer" onclick="showContactDetails(${contact.id})">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center text-white font-semibold mr-4">
                                ${contact.name[0]}
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-900">${contact.name}</h3>
                                <p class="text-sm text-gray-600">${contact.position} Â· ${contact.company}</p>
                                <div class="flex items-center mt-2">
                                    ${contact.industry.map(ind => `<span class="relationship-node">${ind}</span>`).join('')}
                                </div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="flex items-center mb-2">
                                <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">
                                    ${contact.relationshipStrength}%
                                </span>
                            </div>
                            <p class="text-xs text-gray-500">æœ€åè”ç³»: ${contact.lastContact}</p>
                            <p class="text-xs text-gray-500">å…³è”: ${contact.connections.length}äºº</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // æ—¥ç¨‹ç®¡ç†ç›¸å…³å˜é‡å’Œæ•°æ®
        let selectedScheduleDate = new Date();
        let currentScheduleView = 'day'; // 'day' æˆ– 'week'
        let currentWeekOffset = 0; // å‘¨è§†å›¾åç§»é‡
        // æ˜ å°„ï¼šå‰ç«¯ä¼˜å…ˆçº§ <-> åç«¯ç´§æ€¥ç¨‹åº¦
        function priorityToUrgency(p) {
            if (p === 'urgent') return 'urgent';
            if (p === 'high') return 'high';
            if (p === 'low') return 'low';
            return 'medium';
        }
        function urgencyToPriority(u) {
            if (u === 'urgent') return 'urgent';
            if (u === 'high') return 'high';
            if (u === 'low') return 'low';
            return 'medium';
        }
        
        // å•†ä¸šæœºä¼šæ•°æ®
        const opportunitiesData = [
            {
                id: 1, name: 'AIæ™ºèƒ½å®¢æœé¡¹ç›®', type: 'äººå·¥æ™ºèƒ½', 
                info: 'åŸºäºå¤§æ¨¡å‹çš„æ™ºèƒ½å®¢æœè§£å†³æ–¹æ¡ˆï¼Œå·²æœ‰10+ä¼ä¸šå®¢æˆ·',
                expectedFee: '200ä¸‡', cooperationTarget: 'çº¢æ‰èµ„æœ¬',
                recommendedPartners: ['å¼ æ€»-çº¢æ‰èµ„æœ¬', 'ææ€»-è…¾è®¯æŠ•èµ„'],
                contactedPartners: ['å¼ æ€»-çº¢æ‰èµ„æœ¬'], 
                followUp: 'å¼ æ€»è¡¨ç¤ºæ„Ÿå…´è¶£ï¼Œçº¦å®šä¸‹å‘¨è¯¦è°ˆ',
                status: 'active'
            },
            {
                id: 2, name: 'æ–°èƒ½æºå……ç”µæ¡©ç½‘ç»œ', type: 'æ–°èƒ½æº',
                info: 'è¦†ç›–ä¸€çº¿åŸå¸‚çš„æ™ºèƒ½å……ç”µæ¡©ç½‘ç»œï¼Œç”¨æˆ·é‡50ä¸‡+',
                expectedFee: '500ä¸‡', cooperationTarget: 'ç»çº¬åˆ›æŠ•',
                recommendedPartners: ['ç‹æ€»-ç»çº¬åˆ›æŠ•', 'åˆ˜æ€»-å›è”èµ„æœ¬'],
                contactedPartners: [], 
                followUp: 'å¾…è”ç³»æ¨èæŠ•èµ„äºº',
                status: 'pending'
            },
            {
                id: 3, name: 'åŒºå—é“¾ä¾›åº”é“¾é‡‘è', type: 'åŒºå—é“¾',
                info: 'åŸºäºåŒºå—é“¾çš„ä¾›åº”é“¾é‡‘èå¹³å°ï¼Œå·²ä¸3å®¶é“¶è¡Œåˆä½œ',
                expectedFee: '150ä¸‡', cooperationTarget: 'åå…´èµ„æœ¬',
                recommendedPartners: ['é™ˆæ€»-åå…´èµ„æœ¬'],
                contactedPartners: ['é™ˆæ€»-åå…´èµ„æœ¬'], 
                followUp: 'é™ˆæ€»å»ºè®®ä¼˜åŒ–å•†ä¸šæ¨¡å¼åå†è®®',
                status: 'follow_up'
            }
        ];
        
        const scheduleData = [
            {
                id: 1, title: 'å›¢é˜Ÿæ™¨ä¼š', startTime: '09:00', endTime: '09:30',
                location: 'ä¼šè®®å®¤A', priority: 'medium', date: '2024-01-22',
                contactId: null, type: 'meeting', notes: 'è®¨è®ºæœ¬å‘¨å·¥ä½œè®¡åˆ’'
            },
            {
                id: 2, title: 'æŠ•èµ„äººä¼šé¢ - å¼ æ€»', startTime: '10:00', endTime: '11:30',
                location: 'çº¢æ‰èµ„æœ¬åŠå…¬å®¤', priority: 'high', date: '2024-01-23',
                contactId: 1, type: 'meeting', notes: 'å‡†å¤‡é¡¹ç›®BPå’Œè´¢åŠ¡æ¨¡å‹'
            },
            {
                id: 3, title: 'é¡¹ç›®è¿›å±•æ±‡æŠ¥ - è€æ¿', startTime: '15:30', endTime: '16:30',
                location: 'CEOåŠå…¬å®¤', priority: 'urgent', date: '2024-01-23',
                contactId: null, type: 'meeting', notes: 'æ±‡æŠ¥å½“å‰é¡¹ç›®è¿›å±•'
            }
        ];

        // å•†ä¸šæœºä¼šåˆ†æ
        function analyzeOpportunity() {
            const projectName = document.getElementById('projectName').value;
            const industry = document.getElementById('projectIndustry').value;
            const round = document.getElementById('projectRound').value;
            const amount = document.getElementById('projectAmount').value;
            const description = document.getElementById('projectDescription').value;

            if (!projectName || !industry || !round) {
                alert('è¯·å¡«å†™å®Œæ•´çš„é¡¹ç›®ä¿¡æ¯');
                return;
            }

            // åŸºäºè¡Œä¸šå’Œè½®æ¬¡åŒ¹é…æŠ•èµ„äºº
            const recommendations = contacts.filter(contact => {
                // æ£€æŸ¥è¡Œä¸šåŒ¹é…
                const industryMatch = contact.industry.some(ind => 
                    ind.includes(industry) || industry.includes(ind)
                );
                
                // æ£€æŸ¥æŠ•èµ„åå¥½ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
                const roundMatch = contact.investmentPreference ? 
                    contact.investmentPreference.includes(round) : true;
                
                return industryMatch || roundMatch;
            }).map(contact => {
                // è®¡ç®—åŒ¹é…åˆ†æ•°
                let score = 0;
                if (contact.industry.some(ind => ind.includes(industry))) score += 40;
                if (contact.investmentPreference && contact.investmentPreference.includes(round)) score += 30;
                score += contact.relationshipStrength * 0.3; // å…³ç³»å¼ºåº¦å½±å“
                
                return { ...contact, matchScore: Math.min(100, Math.round(score)) };
            }).sort((a, b) => b.matchScore - a.matchScore);

            displayOpportunityRecommendations(recommendations, { projectName, industry, round, amount });
        }

        // æ˜¾ç¤ºå•†ä¸šæœºä¼šæ¨è
        function displayOpportunityRecommendations(recommendations, projectInfo) {
            const container = document.getElementById('opportunityRecommendations');
            
            if (recommendations.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <span class="text-4xl block mb-2">ğŸ˜”</span>
                        <p>æš‚æœªæ‰¾åˆ°åŒ¹é…çš„æŠ•èµ„äººï¼Œå»ºè®®æ‰©å±•å…³ç³»ç½‘ç»œ</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = recommendations.slice(0, 5).map(contact => `
                <div class="recommendation-item p-4 border border-gray-200 rounded-lg hover:bg-gray-50">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center">
                            <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white font-semibold mr-3">
                                ${contact.name[0]}
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-900">${contact.name}</h4>
                                <p class="text-sm text-gray-600">${contact.company}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="text-lg font-bold text-green-600">${contact.matchScore}%</span>
                            <p class="text-xs text-gray-500">åŒ¹é…åº¦</p>
                        </div>
                    </div>
                    <div class="text-sm text-gray-700 mb-3">
                        <p><strong>åŒ¹é…åŸå› :</strong></p>
                        <ul class="list-disc list-inside text-xs space-y-1 mt-1">
                            ${contact.industry.some(ind => ind.includes(projectInfo.industry)) ? 
                                `<li>ä¸“æ³¨${projectInfo.industry}è¡Œä¸šæŠ•èµ„</li>` : ''}
                            ${contact.investmentPreference && contact.investmentPreference.includes(projectInfo.round) ? 
                                `<li>åå¥½${projectInfo.round}æŠ•èµ„</li>` : ''}
                            <li>å…³ç³»å¼ºåº¦: ${contact.relationshipStrength}%</li>
                        </ul>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="scheduleCallWithContact(${contact.id}, '${projectInfo.projectName}')" 
                                class="btn btn-primary text-xs flex-1">ğŸ“ å®‰æ’é€šè¯</button>
                        <button onclick="showContactDetails(${contact.id})" 
                                class="btn btn-secondary text-xs flex-1">ğŸ‘¤ æŸ¥çœ‹è¯¦æƒ…</button>
                    </div>
                </div>
            `).join('');
        }

        // å®‰æ’ä¸è”ç³»äººçš„é€šè¯
        function scheduleCallWithContact(contactId, projectName) {
            const contact = contacts.find(c => c.id === contactId);
            if (contact) {
                // è‡ªåŠ¨åˆ‡æ¢åˆ°æ—¥ç¨‹è§†å›¾å¹¶åˆ›å»ºæ–°çš„é€šè¯å®‰æ’
                showView('schedule');
                
                // åˆ›å»ºæ–°çš„æ—¥ç¨‹é¡¹
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                const tomorrowStr = formatDateToString(tomorrow);
                
                const newSchedule = {
                    id: scheduleData.length + 1,
                    title: `é¡¹ç›®è®¨è®º - ${contact.name}`,
                    startTime: '14:00',
                    endTime: '15:00',
                    location: 'ç”µè¯ä¼šè®®',
                    priority: 'high',
                    date: tomorrowStr,
                    contactId: contactId,
                    type: 'call',
                    notes: `è®¨è®º${projectName}é¡¹ç›®æŠ•èµ„æœºä¼š`
                };
                
                scheduleData.push(newSchedule);
                
                // åˆ‡æ¢åˆ°æ˜å¤©çš„æ—¥æœŸå¹¶åˆ·æ–°æ—¶é—´çº¿
                selectedScheduleDate = tomorrow;
                document.getElementById('scheduleDateSelector').value = tomorrowStr;
                updateScheduleTimelineTitle();
                loadScheduleTimeline();
                
                alert(`å·²ä¸ºæ‚¨å®‰æ’æ˜å¤©14:00ä¸${contact.name}çš„é¡¹ç›®è®¨è®ºé€šè¯`);
            }
        }

        // æ—¥æœŸæ ¼å¼åŒ–å‡½æ•°
        function formatDateToString(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤º
        function formatScheduleDateDisplay(date) {
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const weekdays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
            const weekday = weekdays[date.getDay()];
            
            const today = new Date();
            if (formatDateToString(date) === formatDateToString(today)) {
                return 'ä»Šæ—¥æ—¥ç¨‹æ—¶é—´çº¿';
            } else {
                return `${year}å¹´${month}æœˆ${day}æ—¥ï¼ˆ${weekday}ï¼‰æ—¥ç¨‹æ—¶é—´çº¿`;
            }
        }

        // åˆ‡æ¢æ—¥ç¨‹æ—¥æœŸ
        function changeScheduleDate(dateString) {
            selectedScheduleDate = new Date(dateString);
            updateScheduleTimelineTitle();
            loadScheduleTimeline();
        }

        // å›åˆ°ä»Šå¤©
        function goToScheduleToday() {
            selectedScheduleDate = new Date();
            document.getElementById('scheduleDateSelector').value = formatDateToString(selectedScheduleDate);
            updateScheduleTimelineTitle();
            loadScheduleTimeline();
        }

        // æ›´æ–°æ—¶é—´çº¿æ ‡é¢˜
        function updateScheduleTimelineTitle() {
            document.getElementById('scheduleTimelineTitle').textContent = formatScheduleDateDisplay(selectedScheduleDate);
        }

        // åŠ è½½æ—¥ç¨‹æ—¶é—´çº¿ï¼ˆçº¿ä¸ŠAPIï¼‰
        async function loadScheduleTimeline() {
            const container = document.getElementById('scheduleTimelineTable');
            const selectedDateStr = formatDateToString(selectedScheduleDate);
            let daySchedules = [];
            try {
                const resp = await fetch(`${DATA_API_BASE}/schedules?date=${selectedDateStr}`);
                const data = await resp.json();
                daySchedules = Array.isArray(data.schedules) ? data.schedules : [];
            } catch(_) {}
            
            // ç”Ÿæˆ8:00-20:00çš„æ—¶é—´æ®µ
            const timeSlots = [];
            for (let hour = 8; hour <= 20; hour++) {
                timeSlots.push(`${hour.toString().padStart(2, '0')}:00`);
            }
            
            container.innerHTML = timeSlots.map(timeSlot => {
                const hour = parseInt(timeSlot.split(':')[0]);
                const scheduleInSlot = daySchedules.find(s => {
                    const startHour = parseInt((s.time_slot||'00:00').split(':')[0]);
                    return startHour === hour;
                });
                
                return `
                    <tr class="border-b border-gray-100 hover:bg-gray-50 transition-colors">
                        <td class="py-1 px-3 text-xs font-medium text-gray-600 bg-gray-50 whitespace-nowrap">${timeSlot}-${(parseInt(timeSlot.split(':')[0])+1).toString().padStart(2,'0')}:00</td>
                        <td class="py-1 px-3">
                            <input type="text" 
                                   value="${scheduleInSlot ? (scheduleInSlot.item || '') : ''}" 
                                   placeholder="ç‚¹å‡»è¾“å…¥äº‹é¡¹"
                                   class="notion-input text-lg"
                                   style="padding-top:12px; padding-bottom:12px;"
                                   data-time="${timeSlot}" 
                                   data-field="title"
                                   onchange="updateScheduleField(this)">
                        </td>
                        <td class="py-1 px-3">
                            <select class="w-full px-3 py-2 border border-gray-200 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 text-lg priority-${scheduleInSlot ? urgencyToPriority(scheduleInSlot.urgency||'medium') : 'medium'}"
                                    data-time="${timeSlot}" 
                                    data-field="priority"
                                    onchange="updateScheduleField(this)">
                                <option value="low" ${scheduleInSlot && scheduleInSlot.priority === 'low' ? 'selected' : ''}>ä½</option>
                                <option value="medium" ${scheduleInSlot && scheduleInSlot.priority === 'medium' ? 'selected' : ''}>ä¸­</option>
                                <option value="high" ${scheduleInSlot && scheduleInSlot.priority === 'high' ? 'selected' : ''}>é«˜</option>
                                <option value="urgent" ${scheduleInSlot && scheduleInSlot.priority === 'urgent' ? 'selected' : ''}>ç´§æ€¥</option>
                            </select>
                        </td>
                        <td class="py-1 px-3">
                            <textarea class="w-full px-3 py-2 border border-gray-200 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 text-lg resize-y" 
                                      rows="4"
                                      placeholder="å¤‡æ³¨ä¿¡æ¯ï¼ˆå¯å¤šè¡Œï¼‰"
                                      data-time="${timeSlot}" 
                                      data-field="notes"
                                       onchange="updateScheduleField(this)">${scheduleInSlot ? (scheduleInSlot.notes || '') : ''}</textarea>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // åŠ è½½æ˜æ—¥æé†’äº‹é¡¹
            loadTomorrowReminderCRM();
        }

        // æ›´æ–°æ—¥ç¨‹å­—æ®µï¼ˆçº¿ä¸ŠAPIï¼‰
        async function updateScheduleField(element) {
            const time = element.dataset.time;
            const field = element.dataset.field;
            const value = element.value;
            const selectedDateStr = formatDateToString(selectedScheduleDate);
            try {
                // å–å½“å¤©å·²æœ‰æ•°æ®
                const resp = await fetch(`${DATA_API_BASE}/schedules?date=${selectedDateStr}`);
                const data = await resp.json();
                const daySchedules = Array.isArray(data.schedules) ? data.schedules : [];
                const existing = daySchedules.find(s => (s.time_slot||'') === time);

                if (field === 'title') {
                    const title = (value||'').trim();
                    if (!existing && !title) return; // ç©ºç¼–è¾‘å¿½ç•¥
                    if (existing && !title) {
                        // åˆ é™¤è¯¥æ—¶é—´æ®µ
                        await fetch(`${DATA_API_BASE}/schedules?id=${existing.id}`, { method: 'DELETE' });
                        await loadScheduleTimeline();
                        return;
                    }
                    if (existing) {
                        await fetch(`${DATA_API_BASE}/schedules?id=${existing.id}`, {
                            method: 'PUT', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ item: title })
                        });
                    } else {
                        await fetch(`${DATA_API_BASE}/schedules`, {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ date: selectedDateStr, time_slot: time, item: title, urgency: 'medium' })
                        });
                    }
                    await loadScheduleTimeline();
                    return;
                }

                if (!existing) return; // å…¶ä»–å­—æ®µéœ€å·²å­˜åœ¨
                if (field === 'priority') {
                    await fetch(`${DATA_API_BASE}/schedules?id=${existing.id}`, {
                        method: 'PUT', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ urgency: priorityToUrgency(value) })
                    });
                    await loadScheduleTimeline();
                    return;
                }
                if (field === 'notes') {
                    await fetch(`${DATA_API_BASE}/schedules?id=${existing.id}`, {
                        method: 'PUT', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ notes: value })
                    });
                    return;
                }
            } catch(_) {}
        }

        // ä¿å­˜æ—¥ç¨‹æ›´æ”¹
        function saveScheduleChanges() {
            alert('æ—¥ç¨‹æ›´æ”¹å·²ä¿å­˜ï¼');
        }

        // åŠ è½½æ˜æ—¥æé†’äº‹é¡¹ï¼ˆæ”¯æŒè§£å¯†ï¼‰
        function loadTomorrowReminderCRM() {
            const saved = localStorage.getItem('tomorrow-reminder-crm');
            if (!saved) return;
            (async () => {
                let value = '';
                if (saved && saved.startsWith('{')) {
                    const dec = await decryptString(saved);
                    value = dec ?? '';
                } else {
                    value = saved;
                }
                document.getElementById('tomorrowReminderCRM').value = value;
            })();
        }

        // ä¿å­˜æ˜æ—¥æé†’äº‹é¡¹ï¼ˆä¼˜å…ˆåŠ å¯†ï¼‰
        async function saveTomorrowReminderCRM() {
            const value = document.getElementById('tomorrowReminderCRM').value;
            if (window._encryptionKey) {
                const payload = await encryptString(value);
                if (payload) { localStorage.setItem('tomorrow-reminder-crm', payload); return; }
            }
            localStorage.setItem('tomorrow-reminder-crm', value);
        }

        // ä»Šæ—¥å¾…åŠï¼ˆæ˜æ–‡æœ¬åœ°å­˜å‚¨ï¼‰
        function loadTodayTodos() {
            const v = localStorage.getItem('today-todos') || '';
            const el = document.getElementById('todayTodos');
            if (el) el.value = v;
        }
        function saveTodayTodos() {
            const el = document.getElementById('todayTodos');
            if (!el) return;
            localStorage.setItem('today-todos', el.value || '');
        }

        // åˆå§‹åŒ–æ—¥ç¨‹é€‰æ‹©å™¨
        function initializeScheduleSelector() {
            const today = new Date();
            selectedScheduleDate = today;
            document.getElementById('scheduleDateSelector').value = formatDateToString(today);
            updateScheduleTimelineTitle();
            loadTodayTodos();
            loadTomorrowReminderCRM();
        }

        // è”ç³»äººè§†å›¾åˆ‡æ¢
        function toggleContactView(viewType) {
            if (viewType === 'table') {
                document.getElementById('contactTableView').classList.remove('hidden');
                document.getElementById('contactGraphView').classList.add('hidden');
                document.getElementById('tableViewBtn').className = 'btn-primary text-sm';
                document.getElementById('graphViewBtn').className = 'btn-secondary text-sm';
                loadContactsTable();
            } else {
                document.getElementById('contactTableView').classList.add('hidden');
                document.getElementById('contactGraphView').classList.remove('hidden');
                document.getElementById('tableViewBtn').className = 'btn-secondary text-sm';
                document.getElementById('graphViewBtn').className = 'btn-primary text-sm';
            }
        }

        // åŠ è½½è”ç³»äººè¡¨æ ¼ï¼ˆçº¿ä¸ŠAPIï¼‰
        async function loadContactsTable() {
            const container = document.getElementById('contactsTable');
            try {
                const resp = await fetch(`${DATA_API_BASE}/contacts?limit=100`);
                const data = await resp.json();
                window.__contactsData = Array.isArray(data.contacts) ? data.contacts : [];
            } catch(_) {
                window.__contactsData = [];
            }
            const list = window.__contactsData;
            container.innerHTML = list.map((contact, index) => `
                <tr class="border-b border-gray-100 hover:bg-gray-50 transition-colors">
                    <td class="py-3 px-4 font-medium text-gray-900">${contact.name || ''}</td>
                    <td class="py-3 px-4 text-gray-700">${contact.position || ''}</td>
                    <td class="py-3 px-4 text-gray-700">${contact.company || ''}</td>
                    <td class="py-3 px-4">
                        <div class="flex flex-wrap gap-1">
                            ${(contact.investment_preference||[]).map(pref => `
                                <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs">${pref}</span>
                            `).join('')}
                        </div>
                    </td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 rounded-full text-xs ${
                            contact.relationship_level === 'close' ? 'bg-green-100 text-green-800' :
                            contact.relationship_level === 'medium' ? 'bg-yellow-100 text-yellow-800' :
                            'bg-gray-100 text-gray-800'
                        }">
                            ${(contact.relationship_level === 'close') ? 'å¯†åˆ‡' : 
                              (contact.relationship_level === 'medium') ? 'ä¸€èˆ¬' : 'ç–è¿œ'}
                        </span>
                    </td>
                    <td class="py-3 px-4 text-gray-700">${contact.referred_by || ''}</td>
                    <td class="py-3 px-4 text-sm text-gray-600">${[contact.phone, contact.email].filter(Boolean).join(', ')}</td>
                    <td class="py-3 px-4 text-right">
                        <div class="inline-flex items-center space-x-2">
                            <button onclick="editContact(${contact.id})" class="notion-btn notion-btn-secondary text-xs">ç¼–è¾‘</button>
                            <button onclick="removeContact(${contact.id})" class="notion-btn notion-btn-secondary text-xs">åˆ é™¤</button>
                        </div>
                    </td>
                </tr>
                ${index === list.length - 1 ? `
                <tr class="border-b border-gray-100">
                    <td colspan="8" class="py-3 px-4 text-center">
                        <button onclick="addContact()" class="btn btn-primary text-sm w-full">
                            + æ·»åŠ æ–°è”ç³»äºº
                        </button>
                    </td>
                </tr>
                ` : ''}
            `).join('');
        }

        // æ˜¾ç¤ºè”ç³»äººè¾“å…¥æ¨¡æ€æ¡†
        function showContactInputModal() {
            document.getElementById('contactInputModal').classList.remove('hidden');
            document.getElementById('contactInputModal').classList.add('flex');
            // æ¸…ç©ºè¡¨å•
            document.getElementById('contactTextInput').value = '';
            document.getElementById('contactImageInput').value = '';
            clearParsedFields();
        }

        // éšè—è”ç³»äººè¾“å…¥æ¨¡æ€æ¡†
        function hideContactInputModal() {
            document.getElementById('contactInputModal').classList.add('hidden');
            document.getElementById('contactInputModal').classList.remove('flex');
        }

        // æ¸…ç©ºè§£æå­—æ®µ
        function clearParsedFields() {
            document.getElementById('parsedName').value = '';
            document.getElementById('parsedPosition').value = '';
            document.getElementById('parsedCompany').value = '';
            document.getElementById('parsedPreference').value = '';
            document.getElementById('parsedRelationship').value = 'medium';
            document.getElementById('parsedReferrer').value = '';
            document.getElementById('parsedContact').value = '';
        }

        // æ™ºèƒ½è§£æè”ç³»äººä¿¡æ¯
        function parseContactInfo() {
            const textInput = document.getElementById('contactTextInput').value;
            if (!textInput.trim()) {
                alert('è¯·è¾“å…¥è”ç³»äººä¿¡æ¯');
                return;
            }

            // ç®€å•çš„æ–‡æœ¬è§£æé€»è¾‘ï¼ˆå®é™…é¡¹ç›®ä¸­å¯ä»¥ä½¿ç”¨AI APIï¼‰
            const text = textInput.toLowerCase();
            
            // æå–å§“åï¼ˆé€šå¸¸åœ¨å¼€å¤´ï¼‰
            const nameMatch = textInput.match(/^([^ï¼Œ,\s]+)/);
            if (nameMatch) {
                document.getElementById('parsedName').value = nameMatch[1];
            }

            // æå–å…¬å¸åç§°
            const companyPatterns = [
                /([^ï¼Œ,\s]*èµ„æœ¬[^ï¼Œ,\s]*)/,
                /([^ï¼Œ,\s]*æŠ•èµ„[^ï¼Œ,\s]*)/,
                /([^ï¼Œ,\s]*åŸºé‡‘[^ï¼Œ,\s]*)/,
                /([^ï¼Œ,\s]*åˆ›æŠ•[^ï¼Œ,\s]*)/
            ];
            for (let pattern of companyPatterns) {
                const match = textInput.match(pattern);
                if (match) {
                    document.getElementById('parsedCompany').value = match[1];
                    break;
                }
            }

            // æå–èŒä½
            const positionPatterns = [
                /(ç®¡ç†åˆä¼™äºº|åˆä¼™äºº|æŠ•èµ„æ€»ç›‘|è‘£äº‹æ€»ç»ç†|æ‰§è¡Œè‘£äº‹|VP|æ€»è£|CEO|CTO|CFO)/
            ];
            for (let pattern of positionPatterns) {
                const match = textInput.match(pattern);
                if (match) {
                    document.getElementById('parsedPosition').value = match[1];
                    break;
                }
            }

            // æå–æŠ•èµ„åå¥½
            const industries = ['AI', 'äººå·¥æ™ºèƒ½', 'åŒºå—é“¾', 'æ–°èƒ½æº', 'åŒ»ç–—', 'æ•™è‚²', 'ä¼ä¸šæœåŠ¡', 'æ¶ˆè´¹', 'äº’è”ç½‘', 'æ¸¸æˆ'];
            const rounds = ['å¤©ä½¿è½®', 'Pre-A', 'Aè½®', 'Bè½®', 'Cè½®'];
            const foundPrefs = [];
            
            industries.forEach(industry => {
                if (text.includes(industry.toLowerCase()) || textInput.includes(industry)) {
                    foundPrefs.push(industry);
                }
            });
            
            rounds.forEach(round => {
                if (textInput.includes(round)) {
                    foundPrefs.push(round);
                }
            });
            
            document.getElementById('parsedPreference').value = foundPrefs.join(', ');

            // æå–æ¨èäºº
            const referrerMatch = textInput.match(/([^ï¼Œ,\s]+)æ¨è/);
            if (referrerMatch) {
                document.getElementById('parsedReferrer').value = referrerMatch[1];
            }

            // æå–è”ç³»æ–¹å¼
            const phoneMatch = textInput.match(/(\d{3}[-\s]?\d{4}[-\s]?\d{4})/);
            const emailMatch = textInput.match(/([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/);
            const contacts = [];
            if (phoneMatch) contacts.push(phoneMatch[1]);
            if (emailMatch) contacts.push(emailMatch[1]);
            document.getElementById('parsedContact').value = contacts.join(', ');

            alert('ä¿¡æ¯è§£æå®Œæˆï¼Œè¯·æ£€æŸ¥å¹¶ä¿®æ”¹è¯†åˆ«ç»“æœ');
        }

        // å¤„ç†è”ç³»äººå›¾ç‰‡
        function processContactImage() {
            const fileInput = document.getElementById('contactImageInput');
            const file = fileInput.files[0];
            
            if (file) {
                // è¿™é‡Œå¯ä»¥é›†æˆOCR APIæ¥è¯†åˆ«å›¾ç‰‡ä¸­çš„æ–‡å­—
                alert('å›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼å®é™…ä½¿ç”¨ä¸­å¯ä»¥é›†æˆOCRæœåŠ¡æ¥è‡ªåŠ¨è¯†åˆ«åç‰‡ä¿¡æ¯ã€‚');
                // ç¤ºä¾‹ï¼šå¯ä»¥è°ƒç”¨ç™¾åº¦OCRã€è…¾è®¯OCRç­‰æœåŠ¡
            }
        }

        // ä¿å­˜æ–°è”ç³»äºº
        function saveNewContact() {
            const name = document.getElementById('parsedName').value;
            const position = document.getElementById('parsedPosition').value;
            const company = document.getElementById('parsedCompany').value;
            
            if (!name || !company) {
                alert('è¯·è‡³å°‘å¡«å†™å§“åå’Œå…¬å¸ä¿¡æ¯');
                return;
            }

            const newContact = {
                id: contacts.length + 1,
                name: name,
                position: position,
                company: company,
                phone: document.getElementById('parsedContact').value.split(',')[0] || '',
                email: document.getElementById('parsedContact').value.split(',')[1] || '',
                industry: document.getElementById('parsedPreference').value.split(',').map(s => s.trim()).filter(s => s),
                investmentPreference: document.getElementById('parsedPreference').value.split(',').map(s => s.trim()).filter(s => s),
                relationship: document.getElementById('parsedRelationship').value,
                referrer: document.getElementById('parsedReferrer').value,
                contactInfo: document.getElementById('parsedContact').value,
                relationshipStrength: document.getElementById('parsedRelationship').value === 'close' ? 90 : 
                                    document.getElementById('parsedRelationship').value === 'medium' ? 70 : 50,
                projects: [],
                connections: [],
                lastContact: new Date().toISOString().split('T')[0],
                priority: 'medium'
            };

            contacts.push(newContact);
            hideContactInputModal();
            loadContactsTable();
            alert('è”ç³»äººæ·»åŠ æˆåŠŸï¼');
        }

        // æ—¥ç¨‹è§†å›¾åˆ‡æ¢
        function toggleScheduleView(viewType) {
            currentScheduleView = viewType;
            if (viewType === 'day') {
                document.getElementById('dayScheduleView').classList.remove('hidden');
                document.getElementById('weekScheduleView').classList.add('hidden');
                document.getElementById('dayViewBtn').className = 'btn-primary text-sm';
                document.getElementById('weekViewBtn').className = 'btn-secondary text-sm';
                loadScheduleTimeline();
            } else {
                document.getElementById('dayScheduleView').classList.add('hidden');
                document.getElementById('weekScheduleView').classList.remove('hidden');
                document.getElementById('dayViewBtn').className = 'btn-secondary text-sm';
                document.getElementById('weekViewBtn').className = 'btn-primary text-sm';
                loadWeekView();
            }
        }

        // åŠ è½½å‘¨è§†å›¾
        function loadWeekView() {
            const container = document.getElementById('weekScheduleTable');
            
            // è®¡ç®—å½“å‰å‘¨çš„æ—¥æœŸèŒƒå›´
            const today = new Date(selectedScheduleDate);
            const currentDay = today.getDay();
            const diff = currentDay === 0 ? -6 : 1 - currentDay; // è°ƒæ•´ä¸ºå‘¨ä¸€å¼€å§‹
            const monday = new Date(today);
            monday.setDate(today.getDate() + diff + (currentWeekOffset * 7));
            
            const weekDates = [];
            for (let i = 0; i < 7; i++) {
                const date = new Date(monday);
                date.setDate(monday.getDate() + i);
                weekDates.push(date);
            }
            
            // æ›´æ–°å‘¨è§†å›¾æ ‡é¢˜
            const startDate = weekDates[0];
            const endDate = weekDates[6];
            document.getElementById('weekViewTitle').textContent = 
                `${startDate.getMonth() + 1}æœˆ${startDate.getDate()}æ—¥ - ${endDate.getMonth() + 1}æœˆ${endDate.getDate()}æ—¥ å‘¨ç¨‹æ¦‚è§ˆ`;
            
            // ç”Ÿæˆ8:00-20:00çš„æ—¶é—´æ®µ
            const timeSlots = [];
            for (let hour = 8; hour <= 20; hour++) {
                timeSlots.push(`${hour.toString().padStart(2, '0')}:00`);
            }
            
            container.innerHTML = timeSlots.map(timeSlot => {
                const hour = parseInt(timeSlot.split(':')[0]);
                
                return `
                    <tr class="border-b border-gray-100 hover:bg-gray-50 transition-colors">
                        <td class="py-3 px-3 text-sm font-medium text-gray-600 bg-gray-50">${timeSlot}</td>
                        ${weekDates.map(date => {
                            const dateStr = formatDateToString(date);
                            const daySchedule = scheduleData.find(s => 
                                s.date === dateStr && parseInt(s.startTime.split(':')[0]) === hour
                            );
                            
                            return `
                                <td class="py-3 px-3 border-l border-gray-100">
                                    ${daySchedule ? `
                                        <div class="text-xs p-2 rounded bg-blue-100 text-blue-800 cursor-pointer hover:bg-blue-200" 
                                             onclick="editWeekSchedule('${dateStr}', '${timeSlot}', ${daySchedule.id})"
                                             title="${daySchedule.title}">
                                            <div class="font-medium truncate">${daySchedule.title}</div>
                                            ${daySchedule.location ? `<div class="text-gray-600 truncate">ğŸ“ ${daySchedule.location}</div>` : ''}
                                        </div>
                                    ` : `
                                        <div class="h-8 flex items-center justify-center border border-dashed border-gray-200 rounded cursor-pointer hover:bg-blue-50 text-gray-400"
                                             onclick="addWeekSchedule('${dateStr}', '${timeSlot}')"
                                             title="ç‚¹å‡»æ·»åŠ æ—¥ç¨‹">
                                            +
                                        </div>
                                    `}
                                </td>
                            `;
                        }).join('')}
                    </tr>
                `;
            }).join('');
        }

        // å‘¨è§†å›¾å¯¼èˆª
        function previousWeek() {
            currentWeekOffset--;
            loadWeekView();
        }

        function nextWeek() {
            currentWeekOffset++;
            loadWeekView();
        }

        // å‘¨è§†å›¾ä¸­æ·»åŠ æ—¥ç¨‹
        function addWeekSchedule(dateStr, timeSlot) {
            const title = prompt(`ä¸º ${dateStr} ${timeSlot} æ·»åŠ æ—¥ç¨‹:`);
            if (title) {
                const endHour = (parseInt(timeSlot.split(':')[0]) + 1).toString().padStart(2, '0') + ':00';
                const newSchedule = {
                    id: scheduleData.length + 1,
                    title: title,
                    startTime: timeSlot,
                    endTime: endHour,
                    location: '',
                    type: 'other',
                    priority: 'medium',
                    date: dateStr,
                    contactId: null,
                    notes: ''
                };
                scheduleData.push(newSchedule);
                loadWeekView();
            }
        }

        // ç¼–è¾‘å‘¨è§†å›¾ä¸­çš„æ—¥ç¨‹
        function editWeekSchedule(dateStr, timeSlot, scheduleId) {
            const schedule = scheduleData.find(s => s.id === scheduleId);
            if (schedule) {
                const newTitle = prompt(`ç¼–è¾‘æ—¥ç¨‹æ ‡é¢˜:`, schedule.title);
                if (newTitle !== null) {
                    schedule.title = newTitle;
                    loadWeekView();
                }
            }
        }

        // åŠ è½½å•†ä¸šæœºä¼šè¡¨æ ¼ï¼ˆçº¿ä¸ŠAPIï¼‰
        async function loadOpportunities() {
            const container = document.getElementById('opportunitiesTable');
            let list = [];
            try {
                const resp = await fetch(`${DATA_API_BASE}/opportunities?limit=100`);
                const data = await resp.json();
                list = Array.isArray(data.opportunities) ? data.opportunities : [];
            } catch(_) {}
            container.innerHTML = list.map((opp, index) => `
                <tr class="border-b border-gray-100 hover:bg-gray-50 transition-colors">
                    <td class="py-3 px-4">
                        <input type="text" value="${opp.project_name||''}" 
                               class="w-full px-2 py-1 border border-gray-200 rounded text-sm focus:outline-none focus:ring-1 focus:ring-blue-500"
                               onchange="updateOpportunityField(${opp.id}, 'project_name', this.value)"
                               placeholder="è¾“å…¥é¡¹ç›®åç§°">
                    </td>
                    <td class="py-3 px-4">
                        <input type="text" value="${opp.project_type||''}" 
                               class="w-full px-2 py-1 border border-gray-200 rounded text-sm focus:outline-none focus:ring-1 focus:ring-blue-500"
                               onchange="updateOpportunityField(${opp.id}, 'project_type', this.value)"
                               placeholder="å¦‚ï¼šäººå·¥æ™ºèƒ½">
                    </td>
                    <td class="py-3 px-4">
                        <textarea class="w-full px-2 py-1 border border-gray-200 rounded text-sm resize-none focus:outline-none focus:ring-1 focus:ring-blue-500" 
                                  rows="2" 
                                  onchange="updateOpportunityField(${opp.id}, 'project_info', this.value)"
                                  placeholder="é¡¹ç›®è¯¦ç»†ä¿¡æ¯">${opp.project_info||''}</textarea>
                    </td>
                    <td class="py-3 px-4">
                        <input type="text" value="${opp.expected_fee||''}" 
                               class="w-full px-2 py-1 border border-gray-200 rounded text-sm focus:outline-none focus:ring-1 focus:ring-blue-500"
                               onchange="updateOpportunityField(${opp.id}, 'expected_fee', this.value)"
                               placeholder="å¦‚ï¼š200ä¸‡">
                    </td>
                    <td class="py-3 px-4">
                        <input type="text" value="${opp.cooperation_target||''}" 
                               class="w-full px-2 py-1 border border-gray-200 rounded text-sm focus:outline-none focus:ring-1 focus:ring-blue-500"
                               onchange="updateOpportunityField(${opp.id}, 'cooperation_target', this.value)"
                               placeholder="åˆä½œå¯¹è±¡">
                    </td>
                    <td class="py-3 px-4">
                        <div class="flex flex-wrap gap-1">
                            ${(opp.recommended_partners||[]).map(partner => `
                                                                    <span class="notion-tag notion-tag-purple"
                                      onclick="contactRecommendedPartner('${opp.id}', '${partner}')">${partner}</span>
                            `).join('')}
                            ${(opp.recommended_partners||[]).length === 0 ? '<span class="text-gray-400 text-xs">ç³»ç»Ÿæ¨èä¸­...</span>' : ''}
                        </div>
                    </td>
                    <td class="py-3 px-4">
                        <input type="text" value="${(opp.actual_partners||[]).join(', ')}" 
                               class="w-full px-2 py-1 border border-gray-200 rounded text-sm focus:outline-none focus:ring-1 focus:ring-blue-500"
                               onchange="updateOpportunityField(${opp.id}, 'actual_partners', this.value.split(', ').filter(p => p.trim()))"
                               placeholder="å·²è”ç³»çš„åˆä½œä¼™ä¼´">
                    </td>
                    <td class="py-3 px-4">
                        <textarea class="w-full px-2 py-1 border border-gray-200 rounded text-sm resize-none focus:outline-none focus:ring-1 focus:ring-blue-500" 
                                  rows="2" 
                                  onchange="updateOpportunityField(${opp.id}, 'follow_up_status', this.value)"
                                  placeholder="è·Ÿè¿›æƒ…å†µ...">${opp.follow_up_status||''}</textarea>
                    </td>
                    <td class="py-3 px-4">
                        <button onclick="deleteOpportunity(${opp.id})" class="btn btn-secondary text-xs w-full mb-1">åˆ é™¤</button>
                        <button onclick="generateReport(${opp.id})" class="btn btn-primary text-xs w-full">æŠ¥å‘Š</button>
                    </td>
                </tr>
                ${index === list.length - 1 ? `
                <tr class="border-b border-gray-100">
                    <td colspan="9" class="py-3 px-4 text-center">
                        <button onclick="addNewOpportunity()" class="btn btn-primary text-sm w-full">
                            + æ·»åŠ æ–°çš„å•†ä¸šæœºä¼š
                        </button>
                    </td>
                </tr>
                ` : ''}
            `).join('');
        }

        // æ›´æ–°å•†ä¸šæœºä¼šå­—æ®µ
        async function updateOpportunityField(oppId, field, value) {
            try {
                await fetch(`${DATA_API_BASE}/opportunities?id=${oppId}`, {
                    method: 'PUT', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ [field]: value })
                });
            } catch(_) {}
        }

        // ç”Ÿæˆæ¨èåˆä½œä¼™ä¼´
        function generateRecommendedPartners(oppId) {
            const opp = opportunitiesData.find(o => o.id == oppId);
            if (!opp || !opp.type) return;
            
            // åŸºäºé¡¹ç›®ç±»å‹å’Œè½®æ¬¡åŒ¹é…æŠ•èµ„äºº
            const recommendations = contacts.filter(contact => {
                return contact.industry.some(ind => 
                    ind.includes(opp.type) || opp.type.includes(ind)
                );
            }).map(contact => `${contact.name}-${contact.company}`);
            
            opp.recommendedPartners = recommendations.slice(0, 3); // æœ€å¤šæ¨è3ä¸ª
        }

        // æ·»åŠ æ–°çš„å•†ä¸šæœºä¼š
        async function addNewOpportunity() {
            try {
                await fetch(`${DATA_API_BASE}/opportunities`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ project_name: '', project_type: '', project_info: '', expected_fee: '', cooperation_target: '', status: 'active' })
                });
                loadOpportunities();
            } catch(_) {}
        }

        // åˆ é™¤å•†ä¸šæœºä¼š
        async function deleteOpportunity(oppId) {
            if (!confirm('æ˜¯å¦ç¡®è®¤åˆ é™¤ï¼Ÿ')) return;
            try { await fetch(`${DATA_API_BASE}/opportunities?id=${oppId}`, { method: 'DELETE' }); } catch(_) {}
            loadOpportunities();
        }

        // è”ç³»æ¨èåˆä½œä¼™ä¼´
        async function contactRecommendedPartner(oppId, partnerName) {
            try {
                // è¯»å–å½“å‰è®°å½•
                const resp = await fetch(`${DATA_API_BASE}/opportunities?limit=1&offset=0`);
                // ç®€åŒ–ï¼šè¿™é‡Œç›´æ¥è°ƒç”¨æ›´æ–°ï¼Œå°† actual_partners è¿½åŠ ç”±æœåŠ¡ç«¯å¤„ç†æ›´ç¨³å¦¥
                await fetch(`${DATA_API_BASE}/opportunities?id=${oppId}`, {
                    method: 'PUT', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ follow_up_status: `å·²è”ç³»${partnerName}ï¼Œç­‰å¾…å›å¤` })
                });
                loadOpportunities();
                alert(`å·²æ ‡è®°è”ç³»${partnerName}ï¼Œè¯·åŠæ—¶è·Ÿè¿›ï¼`);
            } catch(_) {}
        }

        // æ›´æ–°è·Ÿè¿›æƒ…å†µ
        function updateFollowUp(oppId, followUpText) {
            const opp = opportunitiesData.find(o => o.id == oppId);
            if (opp) {
                opp.followUp = followUpText;
            }
        }

        // æ·»åŠ è”ç³»äºº
        function addContact() {
            const needRecognition = confirm('æ˜¯å¦éœ€è¦å›¾ç‰‡æˆ–æ–‡å­—è¯†åˆ«ï¼Ÿ\nç‚¹å‡»"ç¡®å®š"è¿›è¡Œæ™ºèƒ½è¯†åˆ«\nç‚¹å‡»"å–æ¶ˆ"æ‰‹åŠ¨è¾“å…¥');
            
            if (needRecognition) {
                // æ™ºèƒ½è¯†åˆ«æ¨¡å¼
                const input = prompt('è¯·è¾“å…¥è”ç³»äººä¿¡æ¯æˆ–æè¿°ï¼š\nä¾‹å¦‚ï¼šå¼ æ€»ï¼Œçº¢æ‰èµ„æœ¬ä¸­å›½åŸºé‡‘ç®¡ç†åˆä¼™äººï¼Œä¸“æ³¨AIå’Œæ–°èƒ½æºæŠ•èµ„ï¼Œææ€»æ¨èï¼Œæ‰‹æœº138-0013-8888');
                if (input) {
                    parseAndAddContact(input);
                }
            } else {
                // æ‰‹åŠ¨è¾“å…¥æ¨¡å¼
                const name = prompt('è”ç³»äººå§“åï¼š');
                if (!name) return;
                
                const company = prompt('æ‰€åœ¨æœºæ„ï¼š');
                if (!company) return;
                
                const position = prompt('èŒä½ï¼š');
                const preference = prompt('æŠ•èµ„åå¥½ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰ï¼š');
                const referrer = prompt('æ¨èäººï¼š');
                const contactInfo = prompt('è”ç³»æ–¹å¼ï¼š');
                
                const newContact = {
                    id: contacts.length + 1,
                    name: name,
                    position: position || '',
                    company: company,
                    phone: contactInfo ? contactInfo.split(',')[0]?.trim() : '',
                    email: contactInfo ? contactInfo.split(',')[1]?.trim() : '',
                    industry: preference ? preference.split(',').map(s => s.trim()).filter(s => s) : [],
                    investmentPreference: preference ? preference.split(',').map(s => s.trim()).filter(s => s) : [],
                    relationship: 'medium',
                    referrer: referrer || '',
                    contactInfo: contactInfo || '',
                    relationshipStrength: 70,
                    projects: [],
                    connections: [],
                    lastContact: new Date().toISOString().split('T')[0],
                    priority: 'medium'
                };
                
                contacts.push(newContact);
                loadContactsTable();
                alert('è”ç³»äººæ·»åŠ æˆåŠŸï¼');
            }
        }

        // è§£æå¹¶æ·»åŠ è”ç³»äºº
        function parseAndAddContact(input) {
            // ç®€å•çš„æ–‡æœ¬è§£æé€»è¾‘
            const text = input.toLowerCase();
            
            // æå–å§“å
            const nameMatch = input.match(/^([^ï¼Œ,\s]+)/);
            const name = nameMatch ? nameMatch[1] : '';
            
            // æå–å…¬å¸åç§°
            const companyPatterns = [
                /([^ï¼Œ,\s]*èµ„æœ¬[^ï¼Œ,\s]*)/,
                /([^ï¼Œ,\s]*æŠ•èµ„[^ï¼Œ,\s]*)/,
                /([^ï¼Œ,\s]*åŸºé‡‘[^ï¼Œ,\s]*)/,
                /([^ï¼Œ,\s]*åˆ›æŠ•[^ï¼Œ,\s]*)/
            ];
            let company = '';
            for (let pattern of companyPatterns) {
                const match = input.match(pattern);
                if (match) {
                    company = match[1];
                    break;
                }
            }
            
            // æå–èŒä½
            const positionMatch = input.match(/(ç®¡ç†åˆä¼™äºº|åˆä¼™äºº|æŠ•èµ„æ€»ç›‘|è‘£äº‹æ€»ç»ç†|æ‰§è¡Œè‘£äº‹|VP|æ€»è£|CEO|CTO|CFO)/);
            const position = positionMatch ? positionMatch[1] : '';
            
            // æå–æŠ•èµ„åå¥½
            const industries = ['AI', 'äººå·¥æ™ºèƒ½', 'åŒºå—é“¾', 'æ–°èƒ½æº', 'åŒ»ç–—', 'æ•™è‚²', 'ä¼ä¸šæœåŠ¡', 'æ¶ˆè´¹', 'äº’è”ç½‘', 'æ¸¸æˆ'];
            const rounds = ['å¤©ä½¿è½®', 'Pre-A', 'Aè½®', 'Bè½®', 'Cè½®'];
            const foundPrefs = [];
            
            industries.forEach(industry => {
                if (text.includes(industry.toLowerCase()) || input.includes(industry)) {
                    foundPrefs.push(industry);
                }
            });
            
            rounds.forEach(round => {
                if (input.includes(round)) {
                    foundPrefs.push(round);
                }
            });
            
            // æå–æ¨èäºº
            const referrerMatch = input.match(/([^ï¼Œ,\s]+)æ¨è/);
            const referrer = referrerMatch ? referrerMatch[1] : '';
            
            // æå–è”ç³»æ–¹å¼
            const phoneMatch = input.match(/(\d{3}[-\s]?\d{4}[-\s]?\d{4})/);
            const emailMatch = input.match(/([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/);
            const contactsList = [];
            if (phoneMatch) contactsList.push(phoneMatch[1]);
            if (emailMatch) contactsList.push(emailMatch[1]);
            
            if (!name || !company) {
                alert('æ— æ³•è¯†åˆ«å§“åæˆ–å…¬å¸ä¿¡æ¯ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥');
                return;
            }
            
            const newContact = {
                id: contacts.length + 1,
                name: name,
                position: position,
                company: company,
                phone: phoneMatch ? phoneMatch[1] : '',
                email: emailMatch ? emailMatch[1] : '',
                industry: foundPrefs,
                investmentPreference: foundPrefs,
                relationship: 'medium',
                referrer: referrer,
                contactInfo: contactsList.join(', '),
                relationshipStrength: 70,
                projects: [],
                connections: [],
                lastContact: new Date().toISOString().split('T')[0],
                priority: 'medium'
            };
            
            contacts.push(newContact);
            loadContactsTable();
            alert(`è”ç³»äººæ·»åŠ æˆåŠŸï¼\nè¯†åˆ«ç»“æœï¼š${name} - ${company} - ${position}`);
        }

        // Excelå¯¼å…¥åŠŸèƒ½
        function importExcelFile() {
            const fileInput = document.getElementById('excelFileInput');
            const file = fileInput.files[0];
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        // è¿™é‡Œå¯ä»¥ä½¿ç”¨SheetJSç­‰åº“æ¥è§£æExcelæ–‡ä»¶
                        // ç°åœ¨å…ˆæä¾›ä¸€ä¸ªç®€å•çš„CSVè§£æç¤ºä¾‹
                        const text = e.target.result;
                        const lines = text.split('\n');
                        const headers = lines[0].split(',');
                        
                        let importedCount = 0;
                        for (let i = 1; i < lines.length; i++) {
                            const values = lines[i].split(',');
                            if (values.length >= 2 && values[0].trim()) {
                                const newProject = {
                                    id: projects.length + importedCount + 1,
                                    name: values[0]?.trim() || '',
                                    stage: values[1]?.trim() || 'initial',
                                    priority: values[2]?.trim() || 'medium',
                                    contacts: [],
                                    industry: values[3]?.trim() || '',
                                    round: values[4]?.trim() || '',
                                    amount: values[5]?.trim() || '',
                                    description: values[6]?.trim() || ''
                                };
                                projects.push(newProject);
                                importedCount++;
                            }
                        }
                        
                        if (importedCount > 0) {
                            loadProjects();
                            alert(`æˆåŠŸå¯¼å…¥ ${importedCount} ä¸ªé¡¹ç›®ï¼`);
                        } else {
                            alert('æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„é¡¹ç›®æ•°æ®');
                        }
                    } catch (error) {
                        alert('æ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·ç¡®ä¿æ–‡ä»¶æ ¼å¼æ­£ç¡®\næ”¯æŒæ ¼å¼ï¼šCSVæ–‡ä»¶ï¼Œåˆ—é¡ºåºä¸ºï¼šé¡¹ç›®åç§°,é˜¶æ®µ,ä¼˜å…ˆçº§,è¡Œä¸š,è½®æ¬¡,é‡‘é¢,æè¿°');
                    }
                };
                
                if (file.name.endsWith('.csv')) {
                    reader.readAsText(file);
                } else {
                    alert('å½“å‰ç‰ˆæœ¬ä»…æ”¯æŒCSVæ ¼å¼æ–‡ä»¶\nè¯·å°†Excelæ–‡ä»¶å¦å­˜ä¸ºCSVæ ¼å¼åé‡æ–°å¯¼å…¥');
                }
            }
        }

        // å ä½å‡½æ•°
        function editContact(id) { alert(`ç¼–è¾‘è”ç³»äºº ID: ${id}`); }
        async function removeContact(id) {
            if (!confirm('æ˜¯å¦ç¡®è®¤åˆ é™¤ï¼Ÿ')) return;
            try {
                await fetch(`${DATA_API_BASE}/contacts?id=${id}`, { method: 'DELETE' });
            } catch(_) {}
            loadContactsTable();
        }
        function addProject() { alert('æ·»åŠ é¡¹ç›®åŠŸèƒ½'); }
        function generateReport(id) { alert(`ç”Ÿæˆé¡¹ç›®æŠ¥å‘Š ID: ${id}`); }
        function contactPerson(id) { alert(`è”ç³»è”ç³»äºº ID: ${id}`); }
        function scheduleWithContact(id) { alert(`å®‰æ’ä¼šè®® è”ç³»äºº ID: ${id}`); }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            setupAuthGate();
            loadDashboard();
            try { applySettings(readSettings()); } catch(_) {}
        });
    </script>

    <style>
        /* Notion é£æ ¼åŸºç¡€æ ·å¼ */
        
        /* ä¾§è¾¹æ  - Notion é£æ ¼ */
        .sidebar {
            @apply bg-gray-50 border-r border-gray-200;
        }
        
        .nav-item {
            @apply block px-4 py-4 rounded-xl hover:bg-gray-50 transition-all duration-200 cursor-pointer;
        }
        
        .nav-item:hover {
            transform: translateX(4px);
        }
        
        .nav-item.active {
            @apply bg-white shadow-sm border border-gray-100;
        }
        
        .nav-item.active:hover {
            transform: none;
        }
        
        /* å¡ç‰‡ - Notion æç®€é£æ ¼ */
        .notion-card {
            @apply bg-white border border-gray-200 rounded-lg p-6 hover:shadow-sm transition-shadow duration-150;
        }
        
        /* è¡¨æ ¼ - Notion é£æ ¼ */
        .notion-table {
            @apply bg-white border border-gray-200 rounded-lg overflow-hidden;
        }
        
        .notion-table thead {
            @apply bg-gray-50;
        }
        
        .notion-table th {
            @apply py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200;
        }
        
        .notion-table td {
            @apply py-3 px-4 border-b border-gray-100 text-sm;
        }
        
        .notion-table tbody tr:hover {
            @apply bg-gray-50;
        }
        
        /* æŒ‰é’® - Notion ç®€æ´é£æ ¼ */
        .notion-btn {
            @apply px-3 py-2 text-sm font-medium rounded-md transition-colors duration-150 focus:outline-none;
        }
        
        .notion-btn-primary {
            @apply bg-blue-600 text-white hover:bg-blue-700;
        }
        
        .notion-btn-secondary {
            @apply bg-gray-100 text-gray-700 hover:bg-gray-200 border border-gray-300;
        }
        
        .notion-btn-ghost {
            @apply text-gray-600 hover:bg-gray-100 hover:text-gray-900;
        }
        
        /* è¾“å…¥æ¡† - Notion é£æ ¼ */
        .notion-input {
            @apply w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500 text-sm transition-colors duration-150;
        }
        
        /* æ ‡ç­¾ - Notion é£æ ¼ */
        .notion-tag {
            @apply inline-flex items-center px-2 py-1 rounded text-xs font-medium;
        }
        
        .notion-tag-gray {
            @apply bg-gray-100 text-gray-800;
        }
        
        .notion-tag-blue {
            @apply bg-blue-100 text-blue-800;
        }
        
        .notion-tag-green {
            @apply bg-green-100 text-green-800;
        }
        
        .notion-tag-yellow {
            @apply bg-yellow-100 text-yellow-800;
        }
        
        .notion-tag-red {
            @apply bg-red-100 text-red-800;
        }
        
        .notion-tag-purple {
            @apply bg-purple-100 text-purple-800 hover:bg-purple-200 cursor-pointer;
        }
        
        /* ç»Ÿè®¡å¡ç‰‡ - Notion é£æ ¼ */
        .notion-stat-card {
            @apply bg-white border border-gray-200 rounded-lg p-4 hover:shadow-sm transition-shadow duration-150;
        }
        
        /* ä¸»è¦å†…å®¹åŒºåŸŸ */
        .main-content {
            @apply bg-white;
        }
        
        /* é¡µé¢æ ‡é¢˜ */
        .page-title {
            @apply text-2xl font-semibold text-gray-900 mb-1;
        }
        
        .page-subtitle {
            @apply text-sm text-gray-600 mb-8;
        }
        
        /* å…³ç³»è¿œè¿‘æ ·å¼ */
        .relationship-close { @apply text-green-600 font-medium; }
        .relationship-medium { @apply text-yellow-600 font-medium; }
        .relationship-distant { @apply text-gray-500; }
        
        /* ä¼˜å…ˆçº§æ ·å¼ */
        .priority-urgent { @apply bg-red-50 text-red-700 border border-red-200; }
        .priority-high { @apply bg-orange-50 text-orange-700 border border-orange-200; }
        .priority-medium { @apply bg-blue-50 text-blue-700 border border-blue-200; }
        .priority-low { @apply bg-gray-50 text-gray-600 border border-gray-200; }
        

        
        /* æ‚¬åœæ•ˆæœ */
        .hover-lift:hover {
            transform: translateY(-1px);
        }
        
        /* åˆ†éš”çº¿ */
        .divider {
            @apply border-b border-gray-200 my-6;
        }
    </style>
</body>
</html>